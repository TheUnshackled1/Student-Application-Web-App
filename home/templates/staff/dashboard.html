{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard — CHMSU</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'home/css/style.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

<!-- ========== PAGE LOADER ========== -->
<div class="page-loader" id="pageLoader">
    <span class="loader-text">LOADING...</span>
    <div class="loader-bar-wrapper">
        <div class="loader-bar-fill" id="loaderFill"></div>
    </div>
    <span class="loader-percent" id="loaderPercent">0%</span>
</div>
<script>
(function(){
    var fill=document.getElementById('loaderFill'),pct=document.getElementById('loaderPercent'),loader=document.getElementById('pageLoader');
    var w=0,stripes='',cols=Math.floor(320/9);
    for(var i=0;i<cols;i++) stripes+='<span class="bar-stripe"></span>';
    fill.innerHTML=stripes;
    var start=Date.now(),duration=1000,loaded=false,done=false;
    var iv=setInterval(function(){
        var elapsed=Date.now()-start,target=Math.min((elapsed/duration)*90,90);
        w+=(target-w)*0.18+0.3;if(w>90&&!loaded)w=90;
        fill.style.width=w+'%';pct.textContent=Math.floor(w)+'%';
    },30);
    function finish(){if(done)return;done=true;clearInterval(iv);fill.style.width='100%';pct.textContent='100%';setTimeout(function(){loader.classList.add('loader-hidden');},250);setTimeout(function(){loader.remove();},750);}
    window.addEventListener('load',function(){loaded=true;var remaining=duration-(Date.now()-start);if(remaining<=0)finish();else{var iv2=setInterval(function(){w+=2;if(w>=100)w=100;fill.style.width=w+'%';pct.textContent=Math.floor(w)+'%';},30);setTimeout(function(){clearInterval(iv2);finish();},remaining);}});
})();
</script>

<!-- ========== NAVBAR ========== -->
<nav class="navbar">
    <div class="navbar-left d-flex align-items-center gap-2">
        <div class="logo">
            <div class="logo-circle">
                <span class="logo-text">CHMSU</span>
            </div>
        </div>
        <a href="{% url 'home:home' %}" class="btn btn-nav btn-nav--link">
            <i class="fa-solid fa-house"></i>
            <span>HOME</span>
        </a>
        <a href="{% url 'home:available_offices' %}" class="btn btn-nav btn-nav--link">
            <i class="fa-solid fa-building"></i>
            <span>AVAILABLE OFFICES</span>
        </a>
        <button class="navbar-toggle" id="navToggle"><i class="fa-solid fa-bars"></i></button>
    </div>
    <div class="navbar-right d-flex align-items-center gap-2" id="navMenu">
        <div class="mobile-nav-links">
            <a href="{% url 'home:home' %}" class="btn btn-nav btn-nav--link"><i class="fa-solid fa-house"></i><span>HOME</span></a>
            <a href="{% url 'home:available_offices' %}" class="btn btn-nav btn-nav--link"><i class="fa-solid fa-building"></i><span>AVAILABLE OFFICES</span></a>
        </div>
        <form method="post" action="{% url 'logout' %}" style="margin:0;">
            {% csrf_token %}
            <button type="submit" class="btn btn-nav btn-nav--link" style="border:none; cursor:pointer;">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>Logout</span>
            </button>
        </form>
    </div>
</nav>

<!-- ========== MAIN CONTENT ========== -->
<main class="main-content">

    <!-- Welcome Banner -->
    <div class="status-banner">
        <div class="status-banner-bg"></div>
        <div class="status-banner-content">
            <div class="status-icon-wrap">
                <i class="fa-solid fa-user-gear"></i>
            </div>
            <div class="status-text">
                <h2 class="status-title">Welcome, {{ staff_name }}</h2>
                <p class="status-message">Staff Dashboard &mdash; Manage student applications and track activity.</p>
            </div>
        </div>
    </div>

    <!-- ===== STATS CARDS ===== -->
    <div class="staff-stats-row">
        <div class="staff-stat-card staff-stat--total">
            <div class="staff-stat-icon"><i class="fa-solid fa-layer-group"></i></div>
            <div class="staff-stat-info">
                <span class="staff-stat-val">{{ stats.total_applications }}</span>
                <span class="staff-stat-lbl">Total Applications</span>
            </div>
        </div>
        <div class="staff-stat-card staff-stat--pending">
            <div class="staff-stat-icon"><i class="fa-solid fa-clock"></i></div>
            <div class="staff-stat-info">
                <span class="staff-stat-val">{{ stats.pending_review }}</span>
                <span class="staff-stat-lbl">Pending Review</span>
            </div>
        </div>
        <div class="staff-stat-card staff-stat--approved">
            <div class="staff-stat-icon"><i class="fa-solid fa-circle-check"></i></div>
            <div class="staff-stat-info">
                <span class="staff-stat-val">{{ stats.approved }}</span>
                <span class="staff-stat-lbl">Approved</span>
            </div>
        </div>
        <div class="staff-stat-card staff-stat--rejected">
            <div class="staff-stat-icon"><i class="fa-solid fa-circle-xmark"></i></div>
            <div class="staff-stat-info">
                <span class="staff-stat-val">{{ stats.rejected }}</span>
                <span class="staff-stat-lbl">Rejected</span>
            </div>
        </div>
    </div>

    <!-- ===== ALL STUDENTS + RECENT ACTIVITY (inline row) ===== -->
    <div class="staff-panels-row">

    <!-- LEFT: All Students Table -->
    <div class="staff-panel">
        <div class="staff-panel-header">
            <div class="staff-panel-header-left">
                <span class="staff-panel-icon staff-panel-icon--green"><i class="fa-solid fa-users"></i></span>
                <h3 class="staff-panel-title">All Students</h3>
                <span class="staff-panel-count">{{ stats.total_applications }}</span>
            </div>
            <div class="staff-panel-filters">
                <button class="staff-filter-btn staff-filter--active" data-filter="all">All</button>
                <button class="staff-filter-btn" data-filter="pending">Pending</button>
                <button class="staff-filter-btn" data-filter="under_review">Under Review</button>
                <button class="staff-filter-btn" data-filter="interview_scheduled">Interview</button>
                <button class="staff-filter-btn" data-filter="office_assigned">Office Assigned</button>
                <button class="staff-filter-btn" data-filter="approved">Approved</button>
                <button class="staff-filter-btn" data-filter="rejected">Rejected</button>
            </div>
        </div>

        <!-- Search bar -->
        <div style="padding: 0 20px 12px;">
            <div style="position: relative;">
                <i class="fa-solid fa-magnifying-glass" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: rgba(255,255,255,0.45); font-size: 13px;"></i>
                <input type="text" id="studentSearchInput" placeholder="Search by name, student ID, or email…"
                       style="width: 100%; padding: 10px 14px 10px 38px; border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; font-size: 13px; font-family: 'Inter', sans-serif; background: rgba(255,255,255,0.06); color: #e2e8f0; transition: all .2s;"
                       onfocus="this.style.borderColor='#0d9488'; this.style.background='rgba(255,255,255,0.10)';"
                       onblur="this.style.borderColor='rgba(255,255,255,0.15)'; this.style.background='rgba(255,255,255,0.06)';">
            </div>
        </div>

        <div class="staff-table-wrap">
            <table class="staff-table" id="applicationsTable">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Student Name</th>
                        <th>Type</th>
                        <th>Course</th>
                        <th>Year</th>
                        <th>Date Filed</th>
                        <th>Status</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in all_students %}
                    <tr data-status="{{ s.status }}" data-search="{{ s.student_id }} {{ s.full_name }} {{ s.email }}">
                        <td class="staff-td-id">{{ s.student_id }}</td>
                        <td>
                            <div class="staff-student-cell">
                                <span class="staff-student-name">{{ s.full_name }}</span>
                                <span class="staff-student-email">{{ s.email }}</span>
                            </div>
                        </td>
                        <td>
                            <span class="staff-app-type-tag staff-app-type--{{ s.app_type_class }}">
                                {% if s.app_type_class == 'new' %}
                                    <i class="fa-solid fa-file-circle-plus"></i>
                                {% else %}
                                    <i class="fa-solid fa-arrows-rotate"></i>
                                {% endif %}
                                {{ s.app_type }}
                            </span>
                        </td>
                        <td class="staff-td-course">{{ s.course }}</td>
                        <td class="staff-td-year">{{ s.year_level_display }}</td>
                        <td class="staff-td-date">{{ s.submitted_at|date:"M d, Y" }}</td>
                        <td>
                            <span class="staff-status-tag staff-status--{{ s.status }}">
                                {{ s.status_display }}
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="staff-action-group">
                                {% if s.is_renewal %}
                                <a href="#" class="staff-action-btn staff-action--view" title="Review (Renewal)" style="opacity:0.6; cursor:default;">
                                    <i class="fa-solid fa-eye"></i>
                                </a>
                                {% else %}
                                <a href="{% url 'home:staff_review_application' s.pk %}" class="staff-action-btn staff-action--view" title="Review">
                                    <i class="fa-solid fa-eye"></i>
                                </a>
                                {% endif %}
                                <!-- Quick status dropdown -->
                                {% if not s.is_renewal %}
                                <div class="staff-action-dropdown">
                                    <button class="staff-action-btn staff-action--status" title="Update Status" onclick="this.nextElementSibling.classList.toggle('show')">
                                        <i class="fa-solid fa-ellipsis-vertical"></i>
                                    </button>
                                    <div class="staff-dropdown-menu">
                                        <form method="post" action="{% url 'home:staff_update_application_status' s.pk %}">
                                            {% csrf_token %}
                                            <input type="hidden" name="next" value="{% url 'home:staff_dashboard' %}">
                                            <button type="submit" name="status" value="pending" class="staff-dropdown-item">
                                                <i class="fa-solid fa-clock"></i> Set Pending
                                            </button>
                                            <button type="submit" name="status" value="under_review" class="staff-dropdown-item">
                                                <i class="fa-solid fa-magnifying-glass"></i> Under Review
                                            </button>
                                            <button type="submit" name="status" value="interview_scheduled" class="staff-dropdown-item">
                                                <i class="fa-solid fa-calendar-check"></i> Schedule Interview
                                            </button>
                                            <button type="submit" name="status" value="rejected" class="staff-dropdown-item staff-dropdown--reject">
                                                <i class="fa-solid fa-circle-xmark"></i> Reject
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="staff-table-empty">
                            <i class="fa-regular fa-folder-open"></i>
                            <p>No students have signed into the system yet.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- RIGHT: Recent Activity -->
    <div class="staff-panel staff-panel--recent">
        <div class="staff-panel-header">
            <div class="staff-panel-header-left">
                <span class="staff-panel-icon staff-panel-icon--blue"><i class="fa-solid fa-clock-rotate-left"></i></span>
                <h3 class="staff-panel-title">Recently Processed</h3>
            </div>
        </div>
        <div class="staff-activity-list">
            {% for app in recent_activity %}
            <div class="staff-activity-item">
                <div class="staff-activity-icon staff-activity--{{ app.status }}">
                    {% if app.status == 'approved' %}
                        <i class="fa-solid fa-circle-check"></i>
                    {% else %}
                        <i class="fa-solid fa-circle-xmark"></i>
                    {% endif %}
                </div>
                <div class="staff-activity-info">
                    <span class="staff-activity-name">{{ app.first_name }} {{ app.last_name }}</span>
                    <span class="staff-activity-detail">{{ app.get_status_display }} &mdash; {{ app.course }}</span>
                </div>
                <div class="staff-activity-meta">
                    <span class="staff-activity-date">{{ app.submitted_at|date:"M d, Y" }}</span>
                    <div style="display:flex; gap:4px; align-items:center;">
                        <span class="staff-app-type-tag staff-app-type--{% if app.app_type == 'Renewal' %}renewal{% else %}new{% endif %}" style="font-size:9px; padding:2px 8px;">
                            {{ app.app_type }}
                        </span>
                        <span class="staff-status-tag staff-status--{{ app.status }}" style="font-size:10px;">{{ app.get_status_display }}</span>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="staff-activity-empty">
                <i class="fa-regular fa-clock"></i>
                <p>No processed applications yet.</p>
            </div>
            {% endfor %}
        </div>
    </div>

    </div><!-- /.staff-panels-row -->

    <!-- ====================================================
         CONTENT MANAGEMENT SECTION
         ==================================================== -->
    <div class="status-banner" style="margin-top:12px;">
        <div class="status-banner-bg"></div>
        <div class="status-banner-content">
            <div class="status-icon-wrap">
                <i class="fa-solid fa-sliders"></i>
            </div>
            <div class="status-text">
                <h2 class="status-title">Content Management</h2>
                <p class="status-message">Manage reminders, important dates, and announcements visible to students on the home page.</p>
            </div>
        </div>
    </div>

    <div class="dashboard-grid dashboard-grid--3col">

        <!-- ===== MANAGE REMINDERS ===== -->
        <div class="card">
            <h3 class="card-title"><i class="fa-solid fa-bell" style="color:#fde68a;"></i> Reminders</h3>

            <!-- Add Reminder Form -->
            <form method="post" action="{% url 'home:staff_add_reminder' %}" class="staff-mgmt-form">
                {% csrf_token %}
                <div class="mb-2">
                    <label class="form-label">Message</label>
                    {{ reminder_form.message }}
                </div>
                <div class="mb-2">
                    <label class="form-label">Priority</label>
                    {{ reminder_form.priority }}
                </div>
                <div class="mb-2 form-check">
                    {{ reminder_form.is_active }}
                    <label class="form-check-label" style="font-size:13px;">Active</label>
                </div>
                <button type="submit" class="btn-primary" style="margin-top:8px;">
                    <i class="fa-solid fa-plus"></i> Add Reminder
                </button>
            </form>

            <hr style="margin:16px 0; border-color:rgba(255,255,255,0.10);">

            <!-- Existing Reminders List -->
            {% for r in reminders %}
            <div class="staff-item-row">
                <div class="staff-item-info">
                    <span class="staff-item-badge staff-badge--{{ r.priority }}">{{ r.get_priority_display }}</span>
                    <span class="staff-item-text">{{ r.message|truncatewords:12 }}</span>
                    {% if not r.is_active %}<span class="staff-item-inactive">(inactive)</span>{% endif %}
                </div>
                <div class="staff-item-actions">
                    <button class="staff-btn-edit" onclick="toggleEditForm('reminder-edit-{{ r.pk }}')" title="Edit">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                    <form method="post" action="{% url 'home:staff_delete_reminder' r.pk %}" style="margin:0;" onsubmit="return confirm('Delete this reminder?');">
                        {% csrf_token %}
                        <button type="submit" class="staff-btn-delete" title="Delete">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
            <!-- Inline Edit Form (hidden by default) -->
            <form method="post" action="{% url 'home:staff_edit_reminder' r.pk %}" class="staff-edit-form" id="reminder-edit-{{ r.pk }}" style="display:none;">
                {% csrf_token %}
                <textarea name="message" class="form-control mb-1" rows="2">{{ r.message }}</textarea>
                <select name="priority" class="form-select mb-1" onchange="updateSelectColor(this)">
                    <option value="info" data-color="#38bdf8" {% if r.priority == 'info' %}selected{% endif %}>Info</option>
                    <option value="warning" data-color="#fbbf24" {% if r.priority == 'warning' %}selected{% endif %}>Warning</option>
                    <option value="urgent" data-color="#ef4444" {% if r.priority == 'urgent' %}selected{% endif %}>Urgent</option>
                </select>
                <div class="form-check mb-1">
                    <input type="checkbox" name="is_active" class="form-check-input" {% if r.is_active %}checked{% endif %}>
                    <label class="form-check-label" style="font-size:13px;">Active</label>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn-primary" style="flex:1; font-size:12px; padding:6px;">Save</button>
                    <button type="button" class="btn-secondary" style="flex:1; font-size:12px; padding:6px;" onclick="toggleEditForm('reminder-edit-{{ r.pk }}')">Cancel</button>
                </div>
            </form>
            {% empty %}
            <p style="font-size:13px; color:#9ca3af; text-align:center;">No reminders yet.</p>
            {% endfor %}
        </div>

        <!-- ===== MANAGE UPCOMING DATES ===== -->
        <div class="card">
            <h3 class="card-title"><i class="fa-regular fa-calendar" style="color:#5eead4;"></i> Important Dates</h3>

            <!-- Add Date Form -->
            <form method="post" action="{% url 'home:staff_add_date' %}" class="staff-mgmt-form">
                {% csrf_token %}
                <div class="mb-2">
                    <label class="form-label">Event Title</label>
                    {{ date_form.title }}
                </div>
                <div class="mb-2">
                    <label class="form-label">Date</label>
                    {{ date_form.date }}
                </div>
                <div class="mb-2 form-check">
                    {{ date_form.is_active }}
                    <label class="form-check-label" style="font-size:13px;">Active</label>
                </div>
                <button type="submit" class="btn-primary" style="margin-top:8px;">
                    <i class="fa-solid fa-plus"></i> Add Date
                </button>
            </form>

            <hr style="margin:16px 0; border-color:rgba(255,255,255,0.10);">

            <!-- Existing Dates List -->
            {% for d in upcoming_dates %}
            <div class="staff-item-row">
                <div class="staff-item-info">
                    <span class="staff-item-date">{{ d.date|date:"M d, Y" }}</span>
                    <span class="staff-item-text">{{ d.title }}</span>
                    {% if not d.is_active %}<span class="staff-item-inactive">(inactive)</span>{% endif %}
                </div>
                <div class="staff-item-actions">
                    <button class="staff-btn-edit" onclick="toggleEditForm('date-edit-{{ d.pk }}')" title="Edit">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                    <form method="post" action="{% url 'home:staff_delete_date' d.pk %}" style="margin:0;" onsubmit="return confirm('Delete this date?');">
                        {% csrf_token %}
                        <button type="submit" class="staff-btn-delete" title="Delete">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
            <!-- Inline Edit Form -->
            <form method="post" action="{% url 'home:staff_edit_date' d.pk %}" class="staff-edit-form" id="date-edit-{{ d.pk }}" style="display:none;">
                {% csrf_token %}
                <input type="text" name="title" class="form-control mb-1" value="{{ d.title }}">
                <input type="date" name="date" class="form-control mb-1" value="{{ d.date|date:'Y-m-d' }}">
                <div class="form-check mb-1">
                    <input type="checkbox" name="is_active" class="form-check-input" {% if d.is_active %}checked{% endif %}>
                    <label class="form-check-label" style="font-size:13px;">Active</label>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn-primary" style="flex:1; font-size:12px; padding:6px;">Save</button>
                    <button type="button" class="btn-secondary" style="flex:1; font-size:12px; padding:6px;" onclick="toggleEditForm('date-edit-{{ d.pk }}')">Cancel</button>
                </div>
            </form>
            {% empty %}
            <p style="font-size:13px; color:#9ca3af; text-align:center;">No dates yet.</p>
            {% endfor %}
        </div>

        <!-- ===== MANAGE ANNOUNCEMENTS ===== -->
        <div class="card">
            <h3 class="card-title"><i class="fa-solid fa-bullhorn" style="color:#86efac;"></i> Announcements</h3>

            <!-- Add Announcement Form -->
            <form method="post" action="{% url 'home:staff_add_announcement' %}" enctype="multipart/form-data" class="staff-mgmt-form">
                {% csrf_token %}
                <div class="mb-2">
                    <label class="form-label">Title</label>
                    {{ announcement_form.title }}
                </div>
                <div class="mb-2">
                    <label class="form-label">Summary</label>
                    {{ announcement_form.summary }}
                </div>
                <div class="mb-2">
                    <label class="form-label">Image (optional)</label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="image" id="id_image" accept="image/*">
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openStaffCamera('id_image')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_id_image"></div>
                </div>
                <div class="mb-2 form-check">
                    {{ announcement_form.is_active }}
                    <label class="form-check-label" style="font-size:13px;">Active</label>
                </div>
                <button type="submit" class="btn-primary" style="margin-top:8px;">
                    <i class="fa-solid fa-plus"></i> Add Announcement
                </button>
            </form>

            <hr style="margin:16px 0; border-color:rgba(255,255,255,0.10);">

            <!-- Existing Announcements List -->
            {% for a in announcements %}
            <div class="staff-item-row">
                <div class="staff-item-info">
                    <span class="staff-item-date">{{ a.published_at|date:"M d" }}</span>
                    <span class="staff-item-text">{{ a.title|truncatewords:8 }}</span>
                    {% if not a.is_active %}<span class="staff-item-inactive">(inactive)</span>{% endif %}
                </div>
                <div class="staff-item-actions">
                    <button class="staff-btn-edit" onclick="toggleEditForm('ann-edit-{{ a.pk }}')" title="Edit">
                        <i class="fa-solid fa-pen"></i>
                    </button>
                    <form method="post" action="{% url 'home:staff_delete_announcement' a.pk %}" style="margin:0;" onsubmit="return confirm('Delete this announcement?');">
                        {% csrf_token %}
                        <button type="submit" class="staff-btn-delete" title="Delete">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
            <!-- Inline Edit Form -->
            <form method="post" action="{% url 'home:staff_edit_announcement' a.pk %}" enctype="multipart/form-data" class="staff-edit-form" id="ann-edit-{{ a.pk }}" style="display:none;">
                {% csrf_token %}
                <input type="text" name="title" class="form-control mb-1" value="{{ a.title }}">
                <textarea name="summary" class="form-control mb-1" rows="2">{{ a.summary }}</textarea>
                <div class="input-with-camera">
                    <div class="custom-file-upload">
                        <input type="file" name="image" id="editAnnFileInput-{{ a.pk }}" accept="image/*">
                        <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                        <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                    </div>
                    <button type="button" class="btn-camera-sm" onclick="openStaffCamera('editAnnFileInput-{{ a.pk }}')">
                        <i class="fa-solid fa-camera"></i>
                    </button>
                </div>
                <div class="file-preview" id="preview_editAnnFileInput-{{ a.pk }}"></div>
                {% if a.image %}
                <p style="font-size:11px; color:rgba(255,255,255,0.45); margin:0 0 4px;">Current: {{ a.image.name }}</p>
                {% endif %}
                <div class="form-check mb-1">
                    <input type="checkbox" name="is_active" class="form-check-input" {% if a.is_active %}checked{% endif %}>
                    <label class="form-check-label" style="font-size:13px;">Active</label>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn-primary" style="flex:1; font-size:12px; padding:6px;">Save</button>
                    <button type="button" class="btn-secondary" style="flex:1; font-size:12px; padding:6px;" onclick="toggleEditForm('ann-edit-{{ a.pk }}')">Cancel</button>
                </div>
            </form>
            {% empty %}
            <p style="font-size:13px; color:#9ca3af; text-align:center;">No announcements yet.</p>
            {% endfor %}
        </div>

    </div>

</main>

<!-- ========== CAMERA MODAL ========== -->
<div class="modal fade" id="staffCameraModal" tabindex="-1" aria-labelledby="staffCameraModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content camera-modal-card">
      <div class="modal-header camera-modal-header">
        <h5 class="modal-title" id="staffCameraModalLabel">
            <i class="fa-solid fa-camera"></i> Take a Photo
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="camera-feed-container">
            <video id="staffCameraFeed" autoplay playsinline></video>
            <canvas id="staffCameraCanvas" style="display:none;"></canvas>
        </div>
        <div class="captured-preview-container" id="staffCapturedPreview" style="display:none;">
            <img id="staffCapturedImage" alt="Captured photo">
        </div>
        <p class="camera-status" id="staffCameraStatus">Starting camera...</p>
      </div>
      <div class="modal-footer camera-modal-footer">
        <button type="button" class="btn-form btn-form--cancel" data-bs-dismiss="modal">
            <i class="fa-solid fa-xmark"></i> Cancel
        </button>
        <button type="button" class="btn-camera-retake" id="staffBtnRetake" style="display:none;" onclick="staffRetakePhoto()">
            <i class="fa-solid fa-arrows-rotate"></i> Retake
        </button>
        <button type="button" class="btn-camera-capture" id="staffBtnCapture" onclick="staffCapturePhoto()">
            <i class="fa-solid fa-camera"></i> Capture
        </button>
        <button type="button" class="btn-form btn-form--submit" id="staffBtnUsePhoto" style="display:none;" onclick="staffUsePhoto()">
            <i class="fa-solid fa-check"></i> Use Photo
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ── Auto-capitalize first letter of each word in text inputs (+ browser autofill) ── */
document.addEventListener('DOMContentLoaded', function() {
    function capitalizeWords(el) {
        var pos = el.selectionStart;
        el.value = el.value.replace(/(?:^|\s|[-\/])([a-z])/g, function(m) { return m.toUpperCase(); });
        try { el.setSelectionRange(pos, pos); } catch(e) {}
    }
    var textInputs = document.querySelectorAll('input[type="text"]:not([inputmode="numeric"]), textarea');
    textInputs.forEach(function(input) {
        input.addEventListener('input', function() { capitalizeWords(this); });
        input.addEventListener('change', function() { capitalizeWords(this); });
    });
    setTimeout(function() {
        textInputs.forEach(function(input) {
            if (input.value) capitalizeWords(input);
        });
    }, 500);
});

/* ── Generic select color mapping ── */
function updateSelectColor(sel) {
    var opt = sel.options[sel.selectedIndex];
    var color = opt && opt.dataset.color ? opt.dataset.color : '#5eead4';
    sel.style.color = color;
    sel.style.borderColor = color;
    sel.style.boxShadow = '0 0 0 3px ' + color + '33';
}

/* ── Staff Camera ── */
var staffCameraStream = null;
var staffCurrentField = null;
var staffCameraModalEl = document.getElementById('staffCameraModal');

function openStaffCamera(fieldId) {
    staffCurrentField = fieldId;
    var modal = new bootstrap.Modal(staffCameraModalEl);
    modal.show();
}

staffCameraModalEl.addEventListener('shown.bs.modal', function() {
    var video = document.getElementById('staffCameraFeed');
    var status = document.getElementById('staffCameraStatus');
    status.textContent = 'Starting camera...';
    navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: 'environment' } })
        .then(function(stream) {
            staffCameraStream = stream;
            video.srcObject = stream;
            status.textContent = 'Camera ready \u2014 click Capture to take a photo';
        })
        .catch(function(err) {
            status.textContent = 'Could not access camera: ' + err.message;
        });
});

staffCameraModalEl.addEventListener('hidden.bs.modal', function() {
    if (staffCameraStream) {
        staffCameraStream.getTracks().forEach(function(t) { t.stop(); });
        staffCameraStream = null;
    }
    document.getElementById('staffCameraFeed').srcObject = null;
    staffResetUI();
});

function staffCapturePhoto() {
    var video = document.getElementById('staffCameraFeed');
    var canvas = document.getElementById('staffCameraCanvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    var dataUrl = canvas.toDataURL('image/png');
    document.getElementById('staffCapturedImage').src = dataUrl;
    document.getElementById('staffCapturedPreview').style.display = 'block';
    video.style.display = 'none';
    document.getElementById('staffBtnCapture').style.display = 'none';
    document.getElementById('staffBtnRetake').style.display = 'inline-flex';
    document.getElementById('staffBtnUsePhoto').style.display = 'inline-flex';
    document.getElementById('staffCameraStatus').textContent = 'Photo captured! Use it or retake.';
}

function staffRetakePhoto() {
    document.getElementById('staffCapturedPreview').style.display = 'none';
    document.getElementById('staffCameraFeed').style.display = 'block';
    document.getElementById('staffBtnCapture').style.display = 'inline-flex';
    document.getElementById('staffBtnRetake').style.display = 'none';
    document.getElementById('staffBtnUsePhoto').style.display = 'none';
    document.getElementById('staffCameraStatus').textContent = 'Camera ready \u2014 click Capture to take a photo';
}

function staffUsePhoto() {
    var canvas = document.getElementById('staffCameraCanvas');
    canvas.toBlob(function(blob) {
        var file = new File([blob], 'camera_photo.jpg', { type: 'image/jpeg' });
        var dt = new DataTransfer();
        dt.items.add(file);
        var input = document.getElementById(staffCurrentField);
        input.files = dt.files;
        // Trigger change to update the custom-file-text
        input.dispatchEvent(new Event('change', { bubbles: true }));
        bootstrap.Modal.getInstance(staffCameraModalEl).hide();
    }, 'image/jpeg', 0.9);
}

function staffResetUI() {
    document.getElementById('staffCapturedPreview').style.display = 'none';
    document.getElementById('staffCameraFeed').style.display = 'block';
    document.getElementById('staffBtnCapture').style.display = 'inline-flex';
    document.getElementById('staffBtnRetake').style.display = 'none';
    document.getElementById('staffBtnUsePhoto').style.display = 'none';
    document.getElementById('staffCameraStatus').textContent = '';
}

// Show file name on file inputs
document.querySelectorAll('input[type="file"]').forEach(function(input) {
    input.addEventListener('change', function() {
        var wrapper = this.closest('.custom-file-upload');
        if (wrapper) {
            var textSpan = wrapper.querySelector('.custom-file-text');
            if (textSpan && this.files.length > 0) {
                textSpan.textContent = this.files[0].name;
                textSpan.classList.add('has-file');
            } else if (textSpan) {
                textSpan.textContent = textSpan.dataset.default;
                textSpan.classList.remove('has-file');
            }
        }
        var card = this.closest('.mb-2') || this.closest('.staff-edit-form');
        if (!card) return;
        var preview = card.querySelector('.file-preview');
        if (preview && this.files.length > 0) {
            preview.innerHTML = '<i class="fa-solid fa-circle-check" style="color:#22c55e;"></i> ' + this.files[0].name;
            preview.style.display = 'block';
        }
    });
});

function toggleEditForm(id) {
    const el = document.getElementById(id);
    if (el) {
        el.style.display = (el.style.display === 'none') ? 'block' : 'none';
    }
}

// ── Table Filter Buttons ──
(function() {
    var btns = document.querySelectorAll('.staff-filter-btn');
    var rows = document.querySelectorAll('#applicationsTable tbody tr[data-status]');
    var currentFilter = 'all';

    btns.forEach(function(btn) {
        btn.addEventListener('click', function() {
            btns.forEach(function(b) { b.classList.remove('staff-filter--active'); });
            btn.classList.add('staff-filter--active');
            currentFilter = btn.getAttribute('data-filter');
            applyFilters();
        });
    });

    // ── Search bar ──
    var searchInput = document.getElementById('studentSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            applyFilters();
        });
    }

    function applyFilters() {
        var search = (searchInput ? searchInput.value : '').toLowerCase().trim();
        rows.forEach(function(row) {
            var matchFilter = (currentFilter === 'all' || row.getAttribute('data-status') === currentFilter);
            var matchSearch = true;
            if (search) {
                var searchText = (row.getAttribute('data-search') || '').toLowerCase();
                matchSearch = searchText.indexOf(search) !== -1;
            }
            row.style.display = (matchFilter && matchSearch) ? '' : 'none';
        });
    }
})();

// ── Close dropdowns when clicking outside ──
document.addEventListener('click', function(e) {
    if (!e.target.closest('.staff-action-dropdown')) {
        document.querySelectorAll('.staff-dropdown-menu.show').forEach(function(m) {
            m.classList.remove('show');
        });
    }
});
</script>
<script>
document.getElementById('navToggle').addEventListener('click',function(){
    document.getElementById('navMenu').classList.toggle('nav-open');
    var i=this.querySelector('i');i.classList.toggle('fa-bars');i.classList.toggle('fa-xmark');
});
</script>
<footer class="site-footer">
    <p>&copy; 2026 Tyrone, Ramsey, Gracee &amp; Dhenby. All rights reserved.</p>
</footer>
</body>
</html>
