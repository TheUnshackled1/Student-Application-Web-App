{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renew as Student Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'home/css/style.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

<!-- ========== PAGE LOADER ========== -->
<div class="page-loader" id="pageLoader">
    <span class="loader-text">LOADING...</span>
    <div class="loader-bar-wrapper">
        <div class="loader-bar-fill" id="loaderFill"></div>
    </div>
    <span class="loader-percent" id="loaderPercent">0%</span>
</div>
<script>
(function(){
    var fill=document.getElementById('loaderFill'),pct=document.getElementById('loaderPercent'),loader=document.getElementById('pageLoader');
    var w=0,stripes='',cols=Math.floor(320/9);
    for(var i=0;i<cols;i++) stripes+='<span class="bar-stripe"></span>';
    fill.innerHTML=stripes;
    var start=Date.now(),duration=1000,loaded=false,done=false;
    var iv=setInterval(function(){
        var elapsed=Date.now()-start,target=Math.min((elapsed/duration)*90,90);
        w+=(target-w)*0.18+0.3;if(w>90&&!loaded)w=90;
        fill.style.width=w+'%';pct.textContent=Math.floor(w)+'%';
    },30);
    function finish(){if(done)return;done=true;clearInterval(iv);fill.style.width='100%';pct.textContent='100%';setTimeout(function(){loader.classList.add('loader-hidden');},250);setTimeout(function(){loader.remove();},750);}
    window.addEventListener('load',function(){loaded=true;var remaining=duration-(Date.now()-start);if(remaining<=0)finish();else{var iv2=setInterval(function(){w+=2;if(w>=100)w=100;fill.style.width=w+'%';pct.textContent=Math.floor(w)+'%';},30);setTimeout(function(){clearInterval(iv2);finish();},remaining);}});
})();
</script>

<!-- ========== NAVBAR ========== -->
<nav class="navbar">
    <div class="navbar-left d-flex align-items-center gap-2">
        <div class="logo">
            <div class="logo-circle">
                <span class="logo-text">CHMSU</span>
            </div>
        </div>
        <a href="{% url 'home:home' %}" class="btn btn-nav btn-nav--link">
            <i class="fa-solid fa-house"></i>
            <span>HOME</span>
        </a>
        <button class="navbar-toggle" id="navToggle"><i class="fa-solid fa-bars"></i></button>
    </div>
    <div class="navbar-right d-flex align-items-center gap-2" id="navMenu">
        <div class="mobile-nav-links">
            <a href="{% url 'home:home' %}" class="btn btn-nav btn-nav--link"><i class="fa-solid fa-house"></i><span>HOME</span></a>
        </div>
        <span class="btn btn-nav btn-nav--active" style="cursor: default;">
            <i class="fa-solid fa-arrows-rotate"></i>
            <span>Renewal</span>
        </span>
    </div>
</nav>

<!-- ========== MAIN CONTENT ========== -->
<main class="main-content">

    <!-- ── Hero Banner with Progress Steps ── -->
    <div class="applyform-hero">
        <div class="applyform-hero-bg"></div>
        <div class="applyform-hero-content">
            <div class="applyform-hero-icon">
                <i class="fa-solid fa-arrows-rotate"></i>
            </div>
            <h2 class="applyform-hero-title">Renew as Student Assistant</h2>
            <p class="applyform-hero-sub">Complete the renewal form below. Your previous records will be referenced. Fields marked with <span style="color:#fbbf24;">*</span> are required.</p>
            <div class="applyform-steps">
                <div class="applyform-step applyform-step--active" data-step="1">
                    <span class="applyform-step-num">1</span>
                    <span class="applyform-step-label">Identity</span>
                </div>
                <div class="applyform-step-line"></div>
                <div class="applyform-step" data-step="2">
                    <span class="applyform-step-num">2</span>
                    <span class="applyform-step-label">Academic</span>
                </div>
                <div class="applyform-step-line"></div>
                <div class="applyform-step" data-step="3">
                    <span class="applyform-step-num">3</span>
                    <span class="applyform-step-label">Assignment</span>
                </div>
                <div class="applyform-step-line"></div>
                <div class="applyform-step" data-step="4">
                    <span class="applyform-step-num">4</span>
                    <span class="applyform-step-label">Documents</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ── Form Card ── -->
    <div class="applyform-card">
        <form method="post" enctype="multipart/form-data" id="applyRenewForm">
            {% csrf_token %}

            <!-- ━━━ SECTION 1: STUDENT IDENTIFICATION ━━━ -->
            <div class="applyform-section" id="section-1">
                <div class="applyform-section-head">
                    <span class="applyform-section-badge">1</span>
                    <div>
                        <h4 class="applyform-section-title">Student Identification</h4>
                        <p class="applyform-section-hint">Enter your Student ID to auto-fill your information, then verify your details.</p>
                    </div>
                </div>

                <!-- Auto-detect banner (hidden by default) -->
                <div class="student-id-alert student-id-alert--success" id="studentIdFound" style="display:none;">
                    <div class="student-id-alert-icon"><i class="fa-solid fa-circle-check"></i></div>
                    <div class="student-id-alert-body">
                        <strong>Student found!</strong>
                        <p id="studentIdFoundText">Your information has been pre-filled from your previous application. Please verify and update if needed.</p>
                    </div>
                </div>
                <div class="student-id-alert student-id-alert--danger" id="studentIdNotFound" style="display:none;">
                    <div class="student-id-alert-icon"><i class="fa-solid fa-circle-xmark"></i></div>
                    <div class="student-id-alert-body">
                        <strong>Student ID not found!</strong>
                        <p>This Student ID is not yet registered in the system. If you are a new applicant, please use the <a href="{% url 'home:apply_new' %}" style="color:#fbbf24;font-weight:600;">New Application</a> form instead.</p>
                    </div>
                </div>

                <div class="applyform-field-group">
                    <span class="applyform-field-group-label"><i class="fa-solid fa-id-card"></i> Basic Info &amp; Contact</span>
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label">Student ID <span class="text-danger">*</span></label>
                            <div class="applyform-input-icon">
                                <i class="fa-solid fa-id-badge"></i>
                                <input type="text" class="form-control" name="student_id" id="id_student_id_renew" maxlength="8" inputmode="numeric" placeholder="12345678" required>
                            </div>
                            <small class="form-text" style="color: rgba(255,255,255,0.55);" id="studentIdStatus">Type your Student ID to auto-detect</small>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Full Name <span class="text-danger">*</span></label>
                            <div class="applyform-input-icon">
                                <i class="fa-solid fa-user"></i>
                                <input type="text" class="form-control" name="full_name" id="id_full_name" placeholder="Juan A. Dela Cruz" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Email Address <span class="text-danger">*</span></label>
                            <div class="applyform-input-icon">
                                <i class="fa-solid fa-at"></i>
                                <input type="email" class="form-control" name="email" id="id_email" placeholder="name@example.com" required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Contact Number <span class="text-danger">*</span></label>
                            <div class="applyform-input-icon">
                                <i class="fa-solid fa-mobile-screen-button"></i>
                                <input type="text" class="form-control" name="contact_number" id="id_contact_number" maxlength="11" inputmode="numeric" pattern="\d{11}" placeholder="09XXXXXXXXX" title="Must be exactly 11 digits" required>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Home Address <span class="text-danger">*</span></label>
                            <div class="applyform-input-icon">
                                <i class="fa-solid fa-location-dot"></i>
                                <input type="text" class="form-control" name="address" id="id_address" placeholder="Street, Brgy, City" required>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ━━━ SECTION 2: CURRENT ACADEMIC INFO ━━━ -->
            <div class="applyform-section" id="section-2">
                <div class="applyform-section-head">
                    <span class="applyform-section-badge applyform-section-badge--blue">2</span>
                    <div>
                        <h4 class="applyform-section-title">Current Academic Information</h4>
                        <p class="applyform-section-hint">Provide your current enrollment details.</p>
                    </div>
                </div>

                <div class="applyform-field-group">
                    <span class="applyform-field-group-label"><i class="fa-solid fa-graduation-cap"></i> Enrollment</span>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Course / Program <span class="text-danger">*</span></label>
                            <div class="applyform-input-icon">
                                <i class="fa-solid fa-book-open"></i>
                                <input type="text" class="form-control" name="course" id="id_course" placeholder="e.g. BSIT, BSCS, BEED" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Year Level <span class="text-danger">*</span></label>
                            <select class="form-select" name="year_level" id="id_year_level" required>
                                <option value="" selected disabled>Select year</option>
                                <option value="1">1st Year</option>
                                <option value="2">2nd Year</option>
                                <option value="3">3rd Year</option>
                                <option value="4">4th Year</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Semester <span class="text-danger">*</span></label>
                            <select class="form-select" name="semester" id="id_semester" required>
                                <option value="" selected disabled>Select semester</option>
                                <option value="1st">1st Semester</option>
                                <option value="2nd">2nd Semester</option>
                            </select>
                        </div>
                    </div>
                    <!-- Eligibility alert (hidden by default) -->
                    <div class="student-id-alert student-id-alert--danger" id="eligibilityAlert" style="display:none;">
                        <div class="student-id-alert-icon"><i class="fa-solid fa-ban"></i></div>
                        <div class="student-id-alert-body">
                            <strong>Not Eligible for Student Assistant</strong>
                            <p id="eligibilityAlertText"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ━━━ SECTION 3: PREVIOUS & PREFERRED ASSIGNMENT ━━━ -->
            <div class="applyform-section" id="section-3">
                <div class="applyform-section-head">
                    <span class="applyform-section-badge applyform-section-badge--amber">3</span>
                    <div>
                        <h4 class="applyform-section-title">Previous &amp; Preferred Assignment</h4>
                        <p class="applyform-section-hint">Tell us about your previous SA experience.</p>
                    </div>
                </div>

                <div class="applyform-field-group">
                    <span class="applyform-field-group-label"><i class="fa-solid fa-building"></i> Office Assignment &amp; Service Record</span>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Previous Office Assigned <span class="text-danger">*</span></label>
                            <select class="form-select" name="previous_office" required>
                                <option value="" selected disabled>Select office</option>
                                <option value="registrar">Registrar</option>
                                <option value="library">Library</option>
                                <option value="guidance">Guidance Office</option>
                                <option value="deans">Dean's Office</option>
                                <option value="cashier">Cashier</option>
                                <option value="osa">Office of Student Affairs</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Preferred Office for Renewal <span class="text-danger">*</span></label>
                            <select class="form-select" name="preferred_office" required>
                                <option value="" selected disabled>Select office</option>
                                <option value="registrar">Registrar</option>
                                <option value="library">Library</option>
                                <option value="guidance">Guidance Office</option>
                                <option value="deans">Dean's Office</option>
                                <option value="cashier">Cashier</option>
                                <option value="osa">Office of Student Affairs</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Total Hours Rendered <span class="text-danger">*</span></label>
                            <div class="applyform-input-icon">
                                <i class="fa-solid fa-hourglass-half"></i>
                                <input type="number" class="form-control" name="hours_rendered" placeholder="e.g. 120" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Supervisor's Name (Previous)</label>
                            <div class="applyform-input-icon">
                                <i class="fa-solid fa-user-tie"></i>
                                <input type="text" class="form-control" name="supervisor_name" placeholder="Full name of your previous supervisor">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ━━━ SECTION 4: REQUIREMENTS FOR RENEWAL ━━━ -->
            <div class="applyform-section" id="section-4">
                <div class="applyform-section-head">
                    <span class="applyform-section-badge" style="background: linear-gradient(135deg, #7c3aed, #a855f7); box-shadow: 0 3px 10px rgba(124, 58, 237, 0.25);">4</span>
                    <div>
                        <h4 class="applyform-section-title">Requirements for Renewal</h4>
                        <p class="applyform-section-hint">Upload scanned copies or take photos of each requirement.</p>
                    </div>
                </div>

                <div class="applyform-docs-grid">

                    <!-- Doc 1 -->
                    <div class="applyform-doc-card">
                        <div class="applyform-doc-num">1</div>
                        <label class="applyform-doc-label">Photocopy of Enrolment Form <span class="text-danger">*</span></label>
                        <div class="input-with-camera">
                            <div class="custom-file-upload">
                                <input type="file" name="enrolment_form" accept=".pdf,.jpg,.png,.jpeg" required>
                                <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                                <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                            </div>
                            <button type="button" class="btn-camera-sm" onclick="openCameraModal('enrolment_form')">
                                <i class="fa-solid fa-camera"></i>
                            </button>
                        </div>
                        <div class="file-preview" id="preview_enrolment_form"></div>
                        <input type="hidden" name="enrolment_form_photo" id="photo_enrolment_form">
                    </div>

                    <!-- Doc 2 -->
                    <div class="applyform-doc-card">
                        <div class="applyform-doc-num">2</div>
                        <label class="applyform-doc-label">Schedule of Classes <span class="text-danger">*</span></label>
                        <div class="input-with-camera">
                            <div class="custom-file-upload">
                                <input type="file" name="schedule_classes" accept=".pdf,.jpg,.png,.jpeg" required>
                                <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                                <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                            </div>
                            <button type="button" class="btn-camera-sm" onclick="openCameraModal('schedule_classes')">
                                <i class="fa-solid fa-camera"></i>
                            </button>
                        </div>
                        <div class="file-preview" id="preview_schedule_classes"></div>
                        <input type="hidden" name="schedule_classes_photo" id="photo_schedule_classes">
                    </div>

                    <!-- Doc 3 -->
                    <div class="applyform-doc-card">
                        <div class="applyform-doc-num">3</div>
                        <label class="applyform-doc-label">Grades for the last semester attended <span class="text-danger">*</span></label>
                        <div class="input-with-camera">
                            <div class="custom-file-upload">
                                <input type="file" name="grades_last_sem" accept=".pdf,.jpg,.png,.jpeg" required>
                                <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                                <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                            </div>
                            <button type="button" class="btn-camera-sm" onclick="openCameraModal('grades_last_sem')">
                                <i class="fa-solid fa-camera"></i>
                            </button>
                        </div>
                        <div class="file-preview" id="preview_grades_last_sem"></div>
                        <input type="hidden" name="grades_last_sem_photo" id="photo_grades_last_sem">
                    </div>

                    <!-- Doc 4 -->
                    <div class="applyform-doc-card">
                        <div class="applyform-doc-num">4</div>
                        <label class="applyform-doc-label">Filled Out Official Time (provided by OSAS) <span class="text-danger">*</span></label>
                        <div class="input-with-camera">
                            <div class="custom-file-upload">
                                <input type="file" name="official_time" accept=".pdf,.jpg,.png,.jpeg" required>
                                <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                                <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                            </div>
                            <button type="button" class="btn-camera-sm" onclick="openCameraModal('official_time')">
                                <i class="fa-solid fa-camera"></i>
                            </button>
                        </div>
                        <div class="file-preview" id="preview_official_time"></div>
                        <input type="hidden" name="official_time_photo" id="photo_official_time">
                    </div>

                    <!-- Doc 5 -->
                    <div class="applyform-doc-card">
                        <div class="applyform-doc-num">5</div>
                        <label class="applyform-doc-label">Recommendation Letter &amp; Budget Allocation <span class="text-danger">*</span></label>
                        <div class="input-with-camera">
                            <div class="custom-file-upload">
                                <input type="file" name="recommendation_letter" accept=".pdf,.jpg,.png,.jpeg" required>
                                <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                                <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                            </div>
                            <button type="button" class="btn-camera-sm" onclick="openCameraModal('recommendation_letter')">
                                <i class="fa-solid fa-camera"></i>
                            </button>
                        </div>
                        <div class="file-preview" id="preview_recommendation_letter"></div>
                        <input type="hidden" name="recommendation_letter_photo" id="photo_recommendation_letter">
                    </div>

                    <!-- Doc 6 -->
                    <div class="applyform-doc-card">
                        <div class="applyform-doc-num">6</div>
                        <label class="applyform-doc-label">Evaluation Form (rating of 80% and above) <span class="text-danger">*</span></label>
                        <div class="input-with-camera">
                            <div class="custom-file-upload">
                                <input type="file" name="evaluation_form" accept=".pdf,.jpg,.png,.jpeg" required>
                                <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                                <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                            </div>
                            <button type="button" class="btn-camera-sm" onclick="openCameraModal('evaluation_form')">
                                <i class="fa-solid fa-camera"></i>
                            </button>
                        </div>
                        <div class="file-preview" id="preview_evaluation_form"></div>
                        <input type="hidden" name="evaluation_form_photo" id="photo_evaluation_form">
                    </div>

                </div>
            </div><!-- /section-4 -->

            <!-- ━━━ SUBMIT AREA ━━━ -->
            <div class="applyform-submit-area">
                <div class="applyform-submit-info">
                    <i class="fa-solid fa-shield-check"></i>
                    <span>Your information is secure and will only be used for this renewal application.</span>
                </div>
                <div class="applyform-submit-actions">
                    <a href="{% url 'home:home' %}" class="btn-form btn-form--cancel">
                        <i class="fa-solid fa-arrow-left"></i> Back to Home
                    </a>
                    <button type="submit" class="btn-form btn-form--submit">
                        <i class="fa-solid fa-paper-plane"></i> Submit Renewal
                    </button>
                </div>
            </div>
        </form>
    </div>

</main>

<!-- ========== CAMERA MODAL ========== -->
<div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content camera-modal-card">
      <div class="modal-header camera-modal-header">
        <h5 class="modal-title" id="cameraModalLabel">
            <i class="fa-solid fa-camera"></i> Take a Photo
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div class="camera-feed-container">
            <video id="cameraFeed" autoplay playsinline></video>
            <canvas id="cameraCanvas" style="display:none;"></canvas>
        </div>
        <div class="captured-preview-container" id="capturedPreview" style="display:none;">
            <img id="capturedImage" alt="Captured photo">
        </div>
        <p class="camera-status" id="cameraStatus">Starting camera...</p>
      </div>
      <div class="modal-footer camera-modal-footer">
        <button type="button" class="btn-form btn-form--cancel" data-bs-dismiss="modal">
            <i class="fa-solid fa-xmark"></i> Cancel
        </button>
        <button type="button" class="btn-camera-retake" id="btnRetake" style="display:none;" onclick="retakePhoto()">
            <i class="fa-solid fa-arrows-rotate"></i> Retake
        </button>
        <button type="button" class="btn-camera-capture" id="btnCapture" onclick="capturePhoto()">
            <i class="fa-solid fa-camera"></i> Capture
        </button>
        <button type="button" class="btn-form btn-form--submit" id="btnUsePhoto" style="display:none;" onclick="usePhoto()">
            <i class="fa-solid fa-check"></i> Use Photo
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let cameraStream = null;
    let currentField = null;
    const cameraModal = document.getElementById('cameraModal');

    function openCameraModal(fieldName) {
        currentField = fieldName;
        const modal = new bootstrap.Modal(cameraModal);
        modal.show();
    }

    cameraModal.addEventListener('shown.bs.modal', function () {
        startCamera();
    });

    cameraModal.addEventListener('hidden.bs.modal', function () {
        stopCamera();
        resetCameraUI();
    });

    function startCamera() {
        const video = document.getElementById('cameraFeed');
        const status = document.getElementById('cameraStatus');
        status.textContent = 'Starting camera...';

        navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: 'user' } })
            .then(function(stream) {
                cameraStream = stream;
                video.srcObject = stream;
                status.textContent = 'Camera ready — click Capture to take a photo';
            })
            .catch(function(err) {
                status.textContent = 'Could not access camera: ' + err.message;
            });
    }

    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(function(track) { track.stop(); });
            cameraStream = null;
        }
        document.getElementById('cameraFeed').srcObject = null;
    }

    function capturePhoto() {
        const video = document.getElementById('cameraFeed');
        const canvas = document.getElementById('cameraCanvas');
        const ctx = canvas.getContext('2d');

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        const dataUrl = canvas.toDataURL('image/png');
        document.getElementById('capturedImage').src = dataUrl;
        document.getElementById('capturedPreview').style.display = 'block';
        video.style.display = 'none';

        document.getElementById('btnCapture').style.display = 'none';
        document.getElementById('btnRetake').style.display = 'inline-flex';
        document.getElementById('btnUsePhoto').style.display = 'inline-flex';
        document.getElementById('cameraStatus').textContent = 'Photo captured! Use it or retake.';
    }

    function retakePhoto() {
        document.getElementById('capturedPreview').style.display = 'none';
        document.getElementById('cameraFeed').style.display = 'block';
        document.getElementById('btnCapture').style.display = 'inline-flex';
        document.getElementById('btnRetake').style.display = 'none';
        document.getElementById('btnUsePhoto').style.display = 'none';
        document.getElementById('cameraStatus').textContent = 'Camera ready — click Capture to take a photo';
    }

    function usePhoto() {
        const canvas = document.getElementById('cameraCanvas');
        const dataUrl = canvas.toDataURL('image/png');

        fetch("{% url 'home:process_camera_photo' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image: dataUrl,
                field: currentField
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.status === 'ok') {
                document.getElementById('photo_' + currentField).value = data.filename;
                var preview = document.getElementById('preview_' + currentField);
                preview.innerHTML = '<i class="fa-solid fa-circle-check" style="color:#22c55e;"></i> <i class="fa-solid fa-camera" style="color:#6b7280;"></i> ' + data.filename;
                preview.style.display = 'block';
            }
        })
        .catch(function(err) {
            alert('Error processing photo: ' + err.message);
        });

        bootstrap.Modal.getInstance(cameraModal).hide();
    }

    function resetCameraUI() {
        document.getElementById('capturedPreview').style.display = 'none';
        document.getElementById('cameraFeed').style.display = 'block';
        document.getElementById('btnCapture').style.display = 'inline-flex';
        document.getElementById('btnRetake').style.display = 'none';
        document.getElementById('btnUsePhoto').style.display = 'none';
        document.getElementById('cameraStatus').textContent = '';
    }

    // Show file name on regular file upload
    document.querySelectorAll('input[type="file"]').forEach(function(input) {
        input.addEventListener('change', function() {
            // Update custom file text
            var wrapper = this.closest('.custom-file-upload');
            if (wrapper) {
                var textSpan = wrapper.querySelector('.custom-file-text');
                if (textSpan && this.files.length > 0) {
                    textSpan.textContent = this.files[0].name;
                    textSpan.classList.add('has-file');
                } else if (textSpan) {
                    textSpan.textContent = textSpan.dataset.default;
                    textSpan.classList.remove('has-file');
                }
            }
            var col = this.closest('.applyform-doc-card') || this.closest('.col-md-6');
            if (!col) return;
            var preview = col.querySelector('.file-preview');
            if (preview && this.files.length > 0) {
                preview.innerHTML = '<i class="fa-solid fa-circle-check" style="color:#22c55e;"></i> ' + this.files[0].name;
                preview.style.display = 'block';
            }
        });
    });

    // ── Progress Step Highlighting (scroll-based) ──
    (function() {
        var sections = [
            document.getElementById('section-1'),
            document.getElementById('section-2'),
            document.getElementById('section-3'),
            document.getElementById('section-4')
        ];
        var steps = document.querySelectorAll('.applyform-step[data-step]');
        var lines = document.querySelectorAll('.applyform-step-line');

        function updateSteps() {
            var active = 0;
            for (var i = 0; i < sections.length; i++) {
                if (sections[i] && sections[i].getBoundingClientRect().top < window.innerHeight * 0.5) {
                    active = i;
                }
            }
            steps.forEach(function(step, idx) {
                step.classList.toggle('applyform-step--active', idx <= active);
            });
            lines.forEach(function(line, idx) {
                line.style.background = idx < active ? 'rgba(200,168,78,0.6)' : 'rgba(255,255,255,0.2)';
            });
        }
        window.addEventListener('scroll', updateSteps, { passive: true });
        updateSteps();
    })();

    // ── Student ID Auto-Detect & Auto-Fill ──
    (function() {
        var sidInput = document.getElementById('id_student_id_renew');
        var foundBox = document.getElementById('studentIdFound');
        var foundText = document.getElementById('studentIdFoundText');
        var notFoundBox = document.getElementById('studentIdNotFound');
        var statusText = document.getElementById('studentIdStatus');
        var checkTimer = null;

        if (!sidInput) return;

        function fillField(id, value) {
            var el = document.getElementById(id);
            if (el && value) {
                el.value = value;
                // Highlight briefly
                el.style.transition = 'box-shadow 0.3s ease';
                el.style.boxShadow = '0 0 0 3px rgba(34,197,94,0.3)';
                setTimeout(function() { el.style.boxShadow = ''; }, 1500);
            }
        }

        sidInput.addEventListener('input', function() {
            clearTimeout(checkTimer);
            var val = this.value.trim();

            // Hide banners while typing
            foundBox.style.display = 'none';
            notFoundBox.style.display = 'none';

            if (val.length < 3) {
                statusText.textContent = 'Type your Student ID to auto-detect';
                statusText.style.color = '';
                return;
            }

            statusText.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking...';
            statusText.style.color = '#6b7280';

            checkTimer = setTimeout(function() {
                fetch("{% url 'home:check_student_id' %}?student_id=" + encodeURIComponent(val))
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.exists) {
                            var d = data.data;
                            // Auto-fill fields
                            fillField('id_full_name', d.full_name);
                            fillField('id_email', d.email);
                            fillField('id_contact_number', d.contact_number);
                            fillField('id_address', d.address);
                            fillField('id_course', d.course);
                            fillField('id_year_level', d.year_level);
                            fillField('id_semester', d.semester);

                            // If previous office info exists, fill it
                            if (d.assigned_office) {
                                var prevOffice = document.querySelector('[name="previous_office"]');
                                if (prevOffice) {
                                    // Try to match the select option
                                    for (var i = 0; i < prevOffice.options.length; i++) {
                                        if (prevOffice.options[i].text.toLowerCase().indexOf(d.assigned_office.toLowerCase()) >= 0 ||
                                            prevOffice.options[i].value.toLowerCase() === d.assigned_office.toLowerCase()) {
                                            prevOffice.selectedIndex = i;
                                            break;
                                        }
                                    }
                                }
                            }

                            foundText.textContent = 'Welcome back, ' + d.full_name + '! Your information has been pre-filled from your previous application. Please verify and update as needed.';
                            foundBox.style.display = 'flex';
                            notFoundBox.style.display = 'none';
                            statusText.innerHTML = '<i class="fa-solid fa-circle-check" style="color:#22c55e;"></i> Student found';
                            statusText.style.color = '#22c55e';
                        } else {
                            foundBox.style.display = 'none';
                            if (val.length >= 5) {
                                notFoundBox.style.display = 'flex';
                                statusText.innerHTML = '<i class="fa-solid fa-circle-xmark" style="color:#ef4444;"></i> Not found';
                                statusText.style.color = '#ef4444';
                            } else {
                                statusText.textContent = 'Type your Student ID to auto-detect';
                                statusText.style.color = '';
                            }
                        }
                    })
                    .catch(function() {
                        statusText.textContent = 'Could not check. Please fill in manually.';
                        statusText.style.color = '#f59e0b';
                    });
            }, 400);
        });
    })();

    // ── Year Level / Semester Eligibility Check ──
    (function() {
        var yearSel = document.getElementById('id_year_level');
        var semSel = document.getElementById('id_semester');
        var alertBox = document.getElementById('eligibilityAlert');
        var alertText = document.getElementById('eligibilityAlertText');
        var submitBtn = document.querySelector('.btn-form--submit[type="submit"]');

        function checkEligibility() {
            var year = yearSel.value;
            var sem = semSel.value;
            var msg = '';

            if (year === '1') {
                msg = '1st year students are not eligible for the Student Assistant program. Only 2nd year, 3rd year, and 4th year (1st semester only) students may apply.';
            } else if (year === '4' && sem === '2nd') {
                msg = '4th year students on their 2nd semester are not eligible because they will be undergoing On-the-Job Training (OJT). Only 4th year — 1st semester students may apply.';
            }

            if (msg) {
                alertText.textContent = msg;
                alertBox.style.display = 'flex';
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.5';
                submitBtn.style.pointerEvents = 'none';
            } else {
                alertBox.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.style.opacity = '';
                submitBtn.style.pointerEvents = '';
            }
        }

        yearSel.addEventListener('change', checkEligibility);
        semSel.addEventListener('change', checkEligibility);
    })();
</script>
<script>
document.getElementById('navToggle').addEventListener('click',function(){
    document.getElementById('navMenu').classList.toggle('nav-open');
    var i=this.querySelector('i');i.classList.toggle('fa-bars');i.classList.toggle('fa-xmark');
});
</script>
</body>
</html>
