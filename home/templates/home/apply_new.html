{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply as New Student Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'home/css/style.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

<div class="page-loader" id="pageLoader">
    <span class="loader-text">LOADING...</span>
    <div class="loader-bar-wrapper">
        <div class="loader-bar-fill" id="loaderFill"></div>
    </div>
    <span class="loader-percent" id="loaderPercent">0%</span>
</div>
<script>
(function(){
    var fill=document.getElementById('loaderFill'),pct=document.getElementById('loaderPercent'),loader=document.getElementById('pageLoader');
    var w=0,stripes='',cols=Math.floor(320/9);
    for(var i=0;i<cols;i++) stripes+='<span class="bar-stripe"></span>';
    fill.innerHTML=stripes;
    var start=Date.now(),duration=1000,loaded=false,done=false;
    var iv=setInterval(function(){
        var elapsed=Date.now()-start,target=Math.min((elapsed/duration)*90,90);
        w+=(target-w)*0.18+0.3;if(w>90&&!loaded)w=90;
        fill.style.width=w+'%';pct.textContent=Math.floor(w)+'%';
    },30);
    function finish(){if(done)return;done=true;clearInterval(iv);fill.style.width='100%';pct.textContent='100%';setTimeout(function(){loader.classList.add('loader-hidden');},250);setTimeout(function(){loader.remove();},750);}
    window.addEventListener('load',function(){loaded=true;var remaining=duration-(Date.now()-start);if(remaining<=0)finish();else{var iv2=setInterval(function(){w+=2;if(w>=100)w=100;fill.style.width=w+'%';pct.textContent=Math.floor(w)+'%';},30);setTimeout(function(){clearInterval(iv2);finish();},remaining);}});
})();
</script>
<nav class="navbar">
    <div class="navbar-left d-flex align-items-center gap-2">
        <div class="logo">
            <div class="logo-circle">
                <span class="logo-text">CHMSU</span>
            </div>
        </div>
        <a href="{% url 'home:home' %}" class="btn btn-nav btn-nav--link">
            <i class="fa-solid fa-house"></i>
            <span>HOME</span>
        </a>
        <button class="navbar-toggle" id="navToggle"><i class="fa-solid fa-bars"></i></button>
    </div>
    <div class="navbar-right d-flex align-items-center gap-2" id="navMenu">
        <div class="mobile-nav-links">
            <a href="{% url 'home:home' %}" class="btn btn-nav btn-nav--link"><i class="fa-solid fa-house"></i><span>HOME</span></a>
        </div>
        <span class="btn btn-nav btn-nav--active" style="cursor: default;">
            <i class="fa-solid fa-file-circle-plus"></i>
            <span>New Application</span>
        </span>
    </div>
</nav>
<main class="main-content">
    <div class="applyform-hero">
        <div class="applyform-hero-bg"></div>
        <div class="applyform-hero-content">
            <div class="applyform-hero-icon">
                <i class="fa-solid fa-file-circle-plus"></i>
            </div>
            <h2 class="applyform-hero-title">Apply as New Student Assistant</h2>
            <p class="applyform-hero-sub">Fill out the form below to submit your application. All fields marked with <span style="color:#fbbf24;">*</span> are required.</p>
            <div class="applyform-steps">
                <div class="applyform-step applyform-step--active" data-step="1">
                    <span class="applyform-step-num">1</span>
                    <span class="applyform-step-label">Personal</span>
                </div>
                <div class="applyform-step-line"></div>
                <div class="applyform-step" data-step="2">
                    <span class="applyform-step-num">2</span>
                    <span class="applyform-step-label">Academic</span>
                </div>
                <div class="applyform-step-line"></div>
                <div class="applyform-step" data-step="3">
                    <span class="applyform-step-num">3</span>
                    <span class="applyform-step-label">Documents</span>
                </div>
            </div>
        </div>
    </div>
    <div class="applyform-card">
        <form method="post" enctype="multipart/form-data" id="applyNewForm">
            {% csrf_token %}

            {% if form.errors %}
            <div class="applyform-errors">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <div>
                    <strong>Please fix the following errors:</strong>
                    <ul>
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                        <li>{{ field|title }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
            <div class="applyform-section" id="section-1">
                <div class="applyform-section-head">
                    <span class="applyform-section-badge">1</span>
                    <div>
                        <h4 class="applyform-section-title">Personal Information</h4>
                        <p class="applyform-section-hint">Enter your full legal name and contact details.</p>
                    </div>
                </div>
                <div class="applyform-field-group">
                    <span class="applyform-field-group-label"><i class="fa-solid fa-signature"></i> Full Name</span>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="first_name" maxlength="15" placeholder="Juan" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">M.I. <span class="text-danger">*</span></label>
                            <input type="text" class="form-control text-center" name="middle_initial" maxlength="1" placeholder="A" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="last_name" maxlength="10" placeholder="Dela Cruz" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Ext.</label>
                            <input type="text" class="form-control text-center" name="extension_name" maxlength="5" placeholder="Jr">
                        </div>
                    </div>
                </div>
                <div class="applyform-field-group">
                    <span class="applyform-field-group-label"><i class="fa-solid fa-calendar-day"></i> Birth, Identity &amp; Contact</span>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" name="date_of_birth" id="id_date_of_birth" required>
                            <small class="form-text" id="dobAgeDisplay" style="color: rgba(255,255,255,0.55); margin-top: 4px;"></small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Gender <span class="text-danger">*</span></label>
                            <select class="form-select gender-select" name="gender" required onchange="updateGenderColor(this)">
                                <option value="" selected disabled>Select gender</option>
                                <option value="male" data-color="#3b82f6">Male</option>
                                <option value="female" data-color="#ec4899">Female</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Contact Number <span class="text-danger">*</span></label>
                            <div class="applyform-input-icon">
                                <i class="fa-solid fa-mobile-screen-button"></i>
                                <input type="text" class="form-control" name="contact_number" maxlength="11" inputmode="numeric" pattern="\d{11}" placeholder="09XXXXXXXXX" title="Must be exactly 11 digits" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Email Address <span class="text-danger">*</span></label>
                            <div class="applyform-input-icon">
                                <i class="fa-solid fa-at"></i>
                                <input type="email" class="form-control" name="email" placeholder="name@example.com" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="applyform-field-group">
                    <span class="applyform-field-group-label"><i class="fa-solid fa-location-dot"></i> Home Address</span>
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Complete Address <span class="text-danger">*</span></label>
                            <div class="applyform-address-wrap">
                                <textarea class="form-control" name="address" id="id_address" rows="2" placeholder="Street, Barangay, City / Municipality, Province" required></textarea>
                                <button type="button" class="applyform-detect-btn" id="btnDetectAddress" onclick="detectAddress()">
                                    <i class="fa-solid fa-location-crosshairs"></i>
                                    <span>Detect Location</span>
                                </button>
                            </div>
                            <small class="form-text" id="addressStatus"></small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="applyform-section" id="section-2">
                <div class="applyform-section-head">
                    <span class="applyform-section-badge applyform-section-badge--blue">2</span>
                    <div>
                        <h4 class="applyform-section-title">Academic Information</h4>
                        <p class="applyform-section-hint">Provide your current enrollment details.</p>
                    </div>
                </div>

                <div class="applyform-field-group">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label">Student ID <span class="text-danger">*</span></label>
                            <div class="applyform-input-icon">
                                <i class="fa-solid fa-id-badge"></i>
                                <input type="text" class="form-control" name="student_id" id="id_student_id_new" maxlength="8" inputmode="numeric" pattern="\d{1,8}" placeholder="12345678" title="Must be up to 8 digits" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Course / Program <span class="text-danger">*</span></label>
                            <select class="form-select course-select" name="course" id="id_course_new" required onchange="updateCourseColor(this)">
                                <option value="" selected disabled>Select college / program</option>
                                <option value="CAS" data-color="#22c55e">CAS — College of Arts and Sciences</option>
                                <option value="CBMA" data-color="#eab308">CBMA — College of Business Management and Accountancy</option>
                                <option value="CCS" data-color="#6b7280">CCS — College of Computer Studies</option>
                                <option value="COEd" data-color="#3b82f6">COEd — College of Education</option>
                                <option value="CIT" data-color="#ef4444">CIT — College of Industrial Technology</option>
                                <option value="COE" data-color="#f97316">COE — College of Engineering</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Year Level <span class="text-danger">*</span></label>
                            <select class="form-select year-select" name="year_level" id="id_year_level" required onchange="updateSelectColor(this)">
                                <option value="" selected disabled>Select year</option>
                                <option value="1" data-color="#94a3b8">1st Year</option>
                                <option value="2" data-color="#22d3ee">2nd Year</option>
                                <option value="3" data-color="#a78bfa">3rd Year</option>
                                <option value="4" data-color="#fbbf24">4th Year</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Semester <span class="text-danger">*</span></label>
                            <select class="form-select semester-select" name="semester" id="id_semester" required onchange="updateSelectColor(this)">
                                <option value="" selected disabled>Select semester</option>
                                <option value="1st" data-color="#34d399">1st Semester</option>
                                <option value="2nd" data-color="#f472b6">2nd Semester</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-1">
                        <div class="col-md-6">
                            <label class="form-label">Preferred Office for Duty <span class="text-danger">*</span></label>
                            <div class="applyform-input-icon">
                                <i class="fa-solid fa-building"></i>
                                <select class="form-select office-select" name="preferred_office" id="id_preferred_office" required onchange="updateSelectColor(this)">
                                    <option value="" selected disabled>Select available office</option>
                                    {% for office in available_offices %}
                                    <option value="{{ office.id }}" data-color="#22d3ee"
                                        {% if office.available == 0 %}disabled{% endif %}>
                                        {{ office.name }}{% if office.available == 0 %} (Full){% else %} — {{ office.available }} slot{{ office.available|pluralize }} available{% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- Eligibility alert (hidden by default) -->
                    <div class="student-id-alert student-id-alert--danger" id="eligibilityAlert" style="display:none;">
                        <div class="student-id-alert-icon"><i class="fa-solid fa-ban"></i></div>
                        <div class="student-id-alert-body">
                            <strong>Not Eligible for Student Assistant</strong>
                            <p id="eligibilityAlertText"></p>
                        </div>
                    </div>
                    <!-- Detection banner (hidden by default) -->
                    <div class="student-id-alert student-id-alert--warning" id="studentIdWarning" style="display:none;">
                        <div class="student-id-alert-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
                        <div class="student-id-alert-body">
                            <strong>Student ID already registered!</strong>
                            <p id="studentIdWarningText">This student ID is already in the system.</p>
                            <a href="{% url 'home:apply_renew' %}" class="student-id-alert-link">
                                <i class="fa-solid fa-arrows-rotate"></i> Go to Renewal Form instead
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ━━━ SECTION 3: DOCUMENTS ━━━ -->
            <div class="applyform-section" id="section-3">
                <div class="applyform-section-head">
                    <span class="applyform-section-badge applyform-section-badge--amber">3</span>
                    <div>
                        <h4 class="applyform-section-title">Requirements for New Applicants</h4>
                        <p class="applyform-section-hint">Upload scanned copies or take photos of each requirement.</p>
                    </div>
                </div>

            <div class="applyform-docs-grid">

                <!-- Doc 1 -->
                <div class="applyform-doc-card">
                    <div class="applyform-doc-num">1</div>
                    <label class="applyform-doc-label">Application Form <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="application_form" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('application_form')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_application_form"></div>
                    <input type="hidden" name="application_form_photo" id="photo_application_form">
                </div>

                <!-- Doc 2 -->
                <div class="applyform-doc-card">
                    <div class="applyform-doc-num">2</div>
                    <label class="applyform-doc-label">(1) 1x1 ID Picture <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="id_picture" accept=".jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('id_picture')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_id_picture"></div>
                    <input type="hidden" name="id_picture_photo" id="photo_id_picture">
                </div>

                <!-- Doc 3 -->
                <div class="applyform-doc-card">
                    <div class="applyform-doc-num">3</div>
                    <label class="applyform-doc-label">Barangay Clearance <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="barangay_clearance" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('barangay_clearance')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_barangay_clearance"></div>
                    <input type="hidden" name="barangay_clearance_photo" id="photo_barangay_clearance">
                </div>

                <!-- Doc 4 -->
                <div class="applyform-doc-card">
                    <div class="applyform-doc-num">4</div>
                    <label class="applyform-doc-label">Parents ITR / BIR Cert. / Cert. of Indigency <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="parents_itr" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('parents_itr')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_parents_itr"></div>
                    <input type="hidden" name="parents_itr_photo" id="photo_parents_itr">
                </div>

                <!-- Doc 5 -->
                <div class="applyform-doc-card">
                    <div class="applyform-doc-num">5</div>
                    <label class="applyform-doc-label">Photocopy of Enrolment Form <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="enrolment_form" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('enrolment_form')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_enrolment_form"></div>
                    <input type="hidden" name="enrolment_form_photo" id="photo_enrolment_form">
                </div>

                <!-- Doc 6 -->
                <div class="applyform-doc-card">
                    <div class="applyform-doc-num">6</div>
                    <label class="applyform-doc-label">Schedule of Classes <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="schedule_classes" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('schedule_classes')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_schedule_classes"></div>
                    <input type="hidden" name="schedule_classes_photo" id="photo_schedule_classes">
                </div>

                <!-- Doc 7 -->
                <div class="applyform-doc-card">
                    <div class="applyform-doc-num">7</div>
                    <label class="applyform-doc-label">Proof of Insurance (c/o OSAS) <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="proof_insurance" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('proof_insurance')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_proof_insurance"></div>
                    <input type="hidden" name="proof_insurance_photo" id="photo_proof_insurance">
                </div>

                <!-- Doc 8 -->
                <div class="applyform-doc-card">
                    <div class="applyform-doc-num">8</div>
                    <label class="applyform-doc-label">Grades for the last semester attended <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="grades_last_sem" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('grades_last_sem')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_grades_last_sem"></div>
                    <input type="hidden" name="grades_last_sem_photo" id="photo_grades_last_sem">
                </div>

                <!-- Doc 9 -->
                <div class="applyform-doc-card">
                    <div class="applyform-doc-num">9</div>
                    <label class="applyform-doc-label">Filled Out Official Time <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="official_time" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('official_time')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_official_time"></div>
                    <input type="hidden" name="official_time_photo" id="photo_official_time">
                </div>

            </div>
            </div><!-- /section-3 -->

            <!-- ━━━ SUBMIT AREA ━━━ -->
            <div class="applyform-submit-area">
                <div class="applyform-submit-info">
                    <i class="fa-solid fa-shield-check"></i>
                    <span>Your information is secure and will only be used for this application.</span>
                </div>
                <div class="applyform-submit-actions">
                    <a href="{% url 'home:home' %}" class="btn-form btn-form--cancel">
                        <i class="fa-solid fa-arrow-left"></i> Back to Home
                    </a>
                    <button type="submit" class="btn-form btn-form--submit">
                        <i class="fa-solid fa-paper-plane"></i> Submit Application
                    </button>
                </div>
            </div>
        </form>
    </div>

</main>

<!-- ========== CAMERA MODAL ========== -->
<div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content camera-modal-card">
      <div class="modal-header camera-modal-header">
        <h5 class="modal-title" id="cameraModalLabel">
            <i class="fa-solid fa-camera"></i> Take a Photo
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <!-- Live camera feed -->
        <div class="camera-feed-container">
            <video id="cameraFeed" autoplay playsinline></video>
            <canvas id="cameraCanvas" style="display:none;"></canvas>
        </div>
        <!-- Captured photo preview -->
        <div class="captured-preview-container" id="capturedPreview" style="display:none;">
            <img id="capturedImage" alt="Captured photo">
        </div>
        <p class="camera-status" id="cameraStatus">Starting camera...</p>
      </div>
      <div class="modal-footer camera-modal-footer">
        <button type="button" class="btn-form btn-form--cancel" data-bs-dismiss="modal">
            <i class="fa-solid fa-xmark"></i> Cancel
        </button>
        <button type="button" class="btn-camera-retake" id="btnRetake" style="display:none;" onclick="retakePhoto()">
            <i class="fa-solid fa-arrows-rotate"></i> Retake
        </button>
        <button type="button" class="btn-camera-capture" id="btnCapture" onclick="capturePhoto()">
            <i class="fa-solid fa-camera"></i> Capture
        </button>
        <button type="button" class="btn-form btn-form--submit" id="btnUsePhoto" style="display:none;" onclick="usePhoto()">
            <i class="fa-solid fa-check"></i> Use Photo
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Generic select color mapping (works for course, gender, year, semester, etc.)
    function updateSelectColor(sel) {
        var opt = sel.options[sel.selectedIndex];
        var color = opt && opt.dataset.color ? opt.dataset.color : '#5eead4';
        sel.style.color = color;
        sel.style.borderColor = color;
        sel.style.boxShadow = '0 0 0 3px ' + color + '33';
    }
    // Aliases for specific selects
    function updateCourseColor(sel) { updateSelectColor(sel); }
    function updateGenderColor(sel) { updateSelectColor(sel); }

    // Auto-capitalize first letter of each word in text inputs (+ browser autofill)
    document.addEventListener('DOMContentLoaded', function() {
        function capitalizeWords(el) {
            var pos = el.selectionStart;
            el.value = el.value.replace(/(?:^|\s|[-\/])([a-z])/g, function(m) { return m.toUpperCase(); });
            try { el.setSelectionRange(pos, pos); } catch(e) {}
        }
        var textInputs = document.querySelectorAll('input[type="text"]:not([inputmode="numeric"]), textarea');
        textInputs.forEach(function(input) {
            input.addEventListener('input', function() { capitalizeWords(this); });
            input.addEventListener('change', function() { capitalizeWords(this); });
        });
        // Handle browser autofill (fires after short delay)
        setTimeout(function() {
            textInputs.forEach(function(input) {
                if (input.value) capitalizeWords(input);
            });
        }, 500);
    });

    let cameraStream = null;
    let currentField = null;
    const cameraModal = document.getElementById('cameraModal');

    // Open webcam modal for a given field
    function openCameraModal(fieldName) {
        currentField = fieldName;
        const modal = new bootstrap.Modal(cameraModal);
        modal.show();
    }

    // When the modal opens, start the webcam
    cameraModal.addEventListener('shown.bs.modal', function () {
        startCamera();
    });

    // When the modal closes, stop the webcam
    cameraModal.addEventListener('hidden.bs.modal', function () {
        stopCamera();
        resetCameraUI();
    });

    function startCamera() {
        const video = document.getElementById('cameraFeed');
        const status = document.getElementById('cameraStatus');
        status.textContent = 'Starting camera...';

        navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: 'user' } })
            .then(function(stream) {
                cameraStream = stream;
                video.srcObject = stream;
                status.textContent = 'Camera ready — click Capture to take a photo';
            })
            .catch(function(err) {
                status.textContent = 'Could not access camera: ' + err.message;
            });
    }

    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(function(track) { track.stop(); });
            cameraStream = null;
        }
        var video = document.getElementById('cameraFeed');
        video.srcObject = null;
    }

    function capturePhoto() {
        const video = document.getElementById('cameraFeed');
        const canvas = document.getElementById('cameraCanvas');
        const ctx = canvas.getContext('2d');

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        // Show preview
        const dataUrl = canvas.toDataURL('image/png');
        document.getElementById('capturedImage').src = dataUrl;
        document.getElementById('capturedPreview').style.display = 'block';
        video.style.display = 'none';

        // Toggle buttons
        document.getElementById('btnCapture').style.display = 'none';
        document.getElementById('btnRetake').style.display = 'inline-flex';
        document.getElementById('btnUsePhoto').style.display = 'inline-flex';
        document.getElementById('cameraStatus').textContent = 'Photo captured! Use it or retake.';
    }

    function retakePhoto() {
        document.getElementById('capturedPreview').style.display = 'none';
        document.getElementById('cameraFeed').style.display = 'block';
        document.getElementById('btnCapture').style.display = 'inline-flex';
        document.getElementById('btnRetake').style.display = 'none';
        document.getElementById('btnUsePhoto').style.display = 'none';
        document.getElementById('cameraStatus').textContent = 'Camera ready — click Capture to take a photo';
    }

    function usePhoto() {
        const canvas = document.getElementById('cameraCanvas');
        const dataUrl = canvas.toDataURL('image/png');

        // Send captured image to backend for cv2 processing
        fetch("{% url 'home:process_camera_photo' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image: dataUrl,
                field: currentField
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.status === 'ok') {
                // Store the processed image data in the hidden field
                document.getElementById('photo_' + currentField).value = data.filename;

                // Update the file-preview in the form
                var preview = document.getElementById('preview_' + currentField);
                preview.innerHTML = '<i class="fa-solid fa-circle-check" style="color:#22c55e;"></i> <i class="fa-solid fa-camera" style="color:#6b7280;"></i> ' + data.filename;
                preview.style.display = 'block';
            }
        })
        .catch(function(err) {
            alert('Error processing photo: ' + err.message);
        });

        // Close the modal
        bootstrap.Modal.getInstance(cameraModal).hide();
    }

    function resetCameraUI() {
        document.getElementById('capturedPreview').style.display = 'none';
        document.getElementById('cameraFeed').style.display = 'block';
        document.getElementById('btnCapture').style.display = 'inline-flex';
        document.getElementById('btnRetake').style.display = 'none';
        document.getElementById('btnUsePhoto').style.display = 'none';
        document.getElementById('cameraStatus').textContent = '';
    }

    // ── Client-side File Validation ──
    var MAX_FILE_MB = 10;
    var ALLOWED_DOC_EXT = ['pdf', 'jpg', 'jpeg', 'png'];
    var ALLOWED_IMG_EXT = ['jpg', 'jpeg', 'png'];
    var VALIDATE_URL = "{% url 'home:validate_document' %}";
    var CSRF = '{{ csrf_token }}';

    function getFileExt(name) {
        return name.split('.').pop().toLowerCase();
    }

    function showFileWarning(card, message, type) {
        /* type: 'error' | 'warning' | 'success' */
        var existing = card.querySelector('.file-validation-msg');
        if (existing) existing.remove();
        var div = document.createElement('div');
        div.className = 'file-validation-msg file-validation-msg--' + type;
        var icon = type === 'error' ? 'fa-circle-xmark' : type === 'warning' ? 'fa-triangle-exclamation' : 'fa-circle-check';
        div.innerHTML = '<i class="fa-solid ' + icon + '"></i> ' + message;
        card.appendChild(div);
    }

    function clearFileWarning(card) {
        var existing = card.querySelector('.file-validation-msg');
        if (existing) existing.remove();
    }

    // Show file name on regular file upload
    document.querySelectorAll('input[type="file"]').forEach(function(input) {
        input.addEventListener('change', function() {
            // Update custom file text
            var wrapper = this.closest('.custom-file-upload');
            if (wrapper) {
                var textSpan = wrapper.querySelector('.custom-file-text');
                if (textSpan && this.files.length > 0) {
                    textSpan.textContent = this.files[0].name;
                    textSpan.classList.add('has-file');
                } else if (textSpan) {
                    textSpan.textContent = textSpan.dataset.default;
                    textSpan.classList.remove('has-file');
                }
            }
            var col = this.closest('.applyform-doc-card') || this.closest('.col-md-6');
            if (!col) return;
            var preview = col.querySelector('.file-preview');
            if (preview && this.files.length > 0) {
                preview.innerHTML = '<i class="fa-solid fa-circle-check" style="color:#22c55e;"></i> ' + this.files[0].name;
                preview.style.display = 'block';
            }

            // Client-side validation
            if (!this.files.length) { clearFileWarning(col); return; }
            var file = this.files[0];
            var fieldName = this.name;
            var ext = getFileExt(file.name);
            var allowed = fieldName === 'id_picture' ? ALLOWED_IMG_EXT : ALLOWED_DOC_EXT;

            // Type check
            if (allowed.indexOf(ext) === -1) {
                showFileWarning(col, 'Invalid file type ".' + ext + '". Allowed: ' + allowed.map(function(e){return '.'+e;}).join(', '), 'error');
                return;
            }

            // Size check
            var sizeMB = file.size / (1024 * 1024);
            if (sizeMB > MAX_FILE_MB) {
                showFileWarning(col, 'File too large (' + sizeMB.toFixed(1) + ' MB). Max: ' + MAX_FILE_MB + ' MB.', 'error');
                return;
            }

            clearFileWarning(col);

            // AJAX server-side validation (OpenCV checks)
            var isImage = ['jpg','jpeg','png'].indexOf(ext) !== -1;
            if (isImage) {
                var formData = new FormData();
                formData.append('file', file);
                formData.append('field', fieldName);
                fetch(VALIDATE_URL, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': CSRF },
                    body: formData
                })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.warnings && data.warnings.length > 0) {
                        showFileWarning(col, data.warnings.join(' '), 'warning');
                    } else {
                        var info = '';
                        if (data.checks && data.checks.resolution) info += data.checks.resolution;
                        if (data.checks && data.checks.blur_score) info += ' · Sharpness: ' + data.checks.blur_score;
                        showFileWarning(col, 'Quality check passed' + (info ? ' (' + info.trim() + ')' : ''), 'success');
                    }
                })
                .catch(function() { /* silent */ });
            }
        });
    });

    // ── Progress Step Highlighting (scroll-based) ──
    (function() {
        var sections = [
            document.getElementById('section-1'),
            document.getElementById('section-2'),
            document.getElementById('section-3')
        ];
        var steps = document.querySelectorAll('.applyform-step[data-step]');
        var lines = document.querySelectorAll('.applyform-step-line');

        function updateSteps() {
            var scrollY = window.scrollY || window.pageYOffset;
            var active = 0;
            for (var i = 0; i < sections.length; i++) {
                if (sections[i] && sections[i].getBoundingClientRect().top < window.innerHeight * 0.5) {
                    active = i;
                }
            }
            steps.forEach(function(step, idx) {
                step.classList.toggle('applyform-step--active', idx <= active);
            });
            lines.forEach(function(line, idx) {
                line.style.background = idx < active ? 'rgba(200,168,78,0.6)' : 'rgba(255,255,255,0.2)';
            });
        }
        window.addEventListener('scroll', updateSteps, { passive: true });
        updateSteps();
    })();

    // ── Address Auto-Detect via Geolocation + Reverse Geocoding ──
    function detectAddress() {
        var btn = document.getElementById('btnDetectAddress');
        var status = document.getElementById('addressStatus');
        var addrField = document.getElementById('id_address');

        if (!navigator.geolocation) {
            status.textContent = 'Geolocation is not supported by your browser.';
            status.style.color = '#ef4444';
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Detecting...';
        status.textContent = 'Getting your location...';
        status.style.color = '#6b7280';

        navigator.geolocation.getCurrentPosition(
            function(position) {
                var lat = position.coords.latitude;
                var lon = position.coords.longitude;
                status.textContent = 'Location found. Fetching address...';

                // Reverse geocode using OpenStreetMap Nominatim (free)
                fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lon + '&addressdetails=1', {
                    headers: { 'Accept-Language': 'en' }
                })
                .then(function(resp) { return resp.json(); })
                .then(function(data) {
                    if (data && data.display_name) {
                        addrField.value = data.display_name;
                        status.innerHTML = '<i class="fa-solid fa-circle-check" style="color:#22c55e;"></i> Address detected successfully.';
                        status.style.color = '#22c55e';
                    } else {
                        status.textContent = 'Could not determine address. Please enter manually.';
                        status.style.color = '#f59e0b';
                    }
                })
                .catch(function() {
                    status.textContent = 'Reverse geocoding failed. Please enter manually.';
                    status.style.color = '#ef4444';
                })
                .finally(function() {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i> Detect';
                });
            },
            function(err) {
                status.textContent = 'Location access denied: ' + err.message;
                status.style.color = '#ef4444';
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i> Detect';
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    }

    // ── Student ID Auto-Detection (warn if already registered) ──
    (function() {
        var sidInput = document.getElementById('id_student_id_new');
        var warningBox = document.getElementById('studentIdWarning');
        var warningText = document.getElementById('studentIdWarningText');
        var checkTimer = null;

        if (!sidInput) return;

        sidInput.addEventListener('input', function() {
            clearTimeout(checkTimer);
            var val = this.value.trim();
            if (val.length < 3) {
                warningBox.style.display = 'none';
                return;
            }
            checkTimer = setTimeout(function() {
                fetch("{% url 'home:check_student_id' %}?student_id=" + encodeURIComponent(val))
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.exists) {
                            warningText.textContent = 'Student ID "' + val + '" belongs to ' + data.data.full_name + ' (' + data.data.status + '). If you are renewing, please use the Renewal form.';
                            warningBox.style.display = 'flex';
                        } else {
                            warningBox.style.display = 'none';
                        }
                    })
                    .catch(function() {
                        warningBox.style.display = 'none';
                    });
            }, 400);
        });
    })();

    // ── Year Level / Semester Eligibility Check ──
    (function() {
        var yearSel = document.getElementById('id_year_level');
        var semSel = document.getElementById('id_semester');
        var alertBox = document.getElementById('eligibilityAlert');
        var alertText = document.getElementById('eligibilityAlertText');
        var submitBtn = document.querySelector('.btn-form--submit[type="submit"]');

        function checkEligibility() {
            var year = yearSel.value;
            var sem = semSel.value;
            var msg = '';

            if (year === '1') {
                msg = '1st year students are not eligible for the Student Assistant program. Only 2nd year, 3rd year, and 4th year (1st semester only) students may apply.';
            } else if (year === '4' && sem === '2nd') {
                msg = '4th year students on their 2nd semester are not eligible because they will be undergoing On-the-Job Training (OJT). Only 4th year — 1st semester students may apply.';
            }

            if (msg) {
                alertText.textContent = msg;
                alertBox.style.display = 'flex';
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.5';
                submitBtn.style.pointerEvents = 'none';
            } else {
                alertBox.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.style.opacity = '';
                submitBtn.style.pointerEvents = '';
            }
        }

        yearSel.addEventListener('change', checkEligibility);
        semSel.addEventListener('change', checkEligibility);
    })();

    // ── Date of Birth: enforce 18+, open picker at 2007 ──
    (function() {
        var dobInput = document.getElementById('id_date_of_birth');
        if (!dobInput) return;

        // Calculate the max allowed date (exactly 18 years ago)
        var today = new Date();
        var maxYear = today.getFullYear() - 18;
        var maxMonth = String(today.getMonth() + 1).padStart(2, '0');
        var maxDay = String(today.getDate()).padStart(2, '0');
        var maxDateStr = maxYear + '-' + maxMonth + '-' + maxDay;
        dobInput.setAttribute('max', maxDateStr);

        // On first click/focus, if empty, temporarily set value to 2007-01-01
        // so the native date picker opens at year 2007 instead of current year.
        var seeded = false;
        dobInput.addEventListener('mousedown', function() {
            if (!this.value && !seeded) {
                seeded = true;
                this.value = maxYear + '-01-01';
                // Clear after a brief moment if user hasn't picked yet
                var self = this;
                setTimeout(function() {
                    if (self.value === maxYear + '-01-01') {
                        // Keep it so the picker opens at that year
                    }
                }, 50);
            }
        });

        // Validate on change — reject dates that would make the student under 18
        dobInput.addEventListener('change', function() {
            if (!this.value) {
                document.getElementById('dobAgeDisplay').textContent = '';
                return;
            }
            var chosen = new Date(this.value);
            var maxDate = new Date(maxYear, today.getMonth(), today.getDate());

            // Calculate age in years and days
            var age = today.getFullYear() - chosen.getFullYear();
            var m = today.getMonth() - chosen.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < chosen.getDate())) {
                age--;
            }

            // Calculate remaining days since last birthday
            var lastBirthday = new Date(today.getFullYear(), chosen.getMonth(), chosen.getDate());
            if (lastBirthday > today) {
                lastBirthday.setFullYear(lastBirthday.getFullYear() - 1);
            }
            var days = Math.floor((today - lastBirthday) / (1000 * 60 * 60 * 24));

            // Build age string with days
            var ageStr = age + ' years';
            if (days > 0) {
                ageStr += ' and ' + days + ' day' + (days !== 1 ? 's' : '');
            }
            ageStr += ' old';

            // Display age
            var ageDisplay = document.getElementById('dobAgeDisplay');
            if (age >= 18) {
                ageDisplay.innerHTML = '<i class="fa-solid fa-circle-check" style="color:#22c55e;"></i> <strong style="color:#e2e8f0;">' + ageStr + '</strong>';
            } else {
                ageDisplay.innerHTML = '<i class="fa-solid fa-circle-xmark" style="color:#fca5a5;"></i> <strong style="color:#fca5a5;">' + ageStr + ' — Must be 18+</strong>';
            }

            if (chosen > maxDate) {
                this.setCustomValidity('You must be at least 18 years old to apply. This program is for college-level students only.');
                this.reportValidity();
            } else {
                this.setCustomValidity('');
            }
        });
    })();
</script>
<script>
document.getElementById('navToggle').addEventListener('click',function(){
    document.getElementById('navMenu').classList.toggle('nav-open');
    var i=this.querySelector('i');i.classList.toggle('fa-bars');i.classList.toggle('fa-xmark');
});
</script>
<footer class="site-footer">
    <p>&copy; 2026 Tyrone, Ramsey, Gracee &amp; Dhenby. All rights reserved.</p>
</footer>
</body>
</html>
