{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply as New Student Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'home/css/style.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

<!-- ========== NAVBAR ========== -->
<nav class="navbar">
    <div class="navbar-left d-flex align-items-center gap-2">
        <div class="logo">
            <div class="logo-circle">
                <span class="logo-text">CHMSU</span>
            </div>
        </div>
        <a href="{% url 'home:home' %}" class="btn btn-nav btn-nav--link">
            <i class="fa-solid fa-house"></i>
            <span>HOME</span>
        </a>
    </div>
    <div class="navbar-right d-flex align-items-center gap-2">
        <span class="btn btn-nav btn-nav--active" style="cursor: default;">
            <i class="fa-solid fa-file-circle-plus"></i>
            <span>New Application</span>
        </span>
    </div>
</nav>

<!-- ========== MAIN CONTENT ========== -->
<main class="main-content">

    <div class="form-page-header">
        <div class="form-icon-circle">
            <i class="fa-solid fa-file-circle-plus"></i>
        </div>
        <h2 class="form-page-title">Apply as New Student Assistant</h2>
        <p class="form-page-subtitle">Fill out the form below to submit your application. All fields marked with <span class="text-danger">*</span> are required.</p>
    </div>

    <div class="form-card">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Personal Information -->
            <h4 class="form-section-title"><i class="fa-solid fa-user"></i> Personal Information</h4>
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="form-label">First Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="first_name" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Middle Name</label>
                    <input type="text" class="form-control" name="middle_name">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Last Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="last_name" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" name="date_of_birth" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Gender <span class="text-danger">*</span></label>
                    <select class="form-select" name="gender" required>
                        <option value="" selected disabled>Select gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Contact Number <span class="text-danger">*</span></label>
                    <input type="tel" class="form-control" name="contact_number" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Email Address <span class="text-danger">*</span></label>
                    <input type="email" class="form-control" name="email" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Home Address <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="address" required>
                </div>
            </div>

            <!-- Academic Information -->
            <h4 class="form-section-title"><i class="fa-solid fa-graduation-cap"></i> Academic Information</h4>
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label class="form-label">Student ID <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="student_id" required>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Course / Program <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="course" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Year Level <span class="text-danger">*</span></label>
                    <select class="form-select" name="year_level" required>
                        <option value="" selected disabled>Select year</option>
                        <option value="1">1st Year</option>
                        <option value="2">2nd Year</option>
                        <option value="3">3rd Year</option>
                        <option value="4">4th Year</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Semester <span class="text-danger">*</span></label>
                    <select class="form-select" name="semester" required>
                        <option value="" selected disabled>Select semester</option>
                        <option value="1st">1st Semester</option>
                        <option value="2nd">2nd Semester</option>
                        <option value="summer">Summer</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">GPA / GWA <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="gpa" required>
                </div>
            </div>

            <!-- Requirements for New Applicants -->
            <h4 class="form-section-title"><i class="fa-solid fa-clipboard-list"></i> Requirements for New Applicants</h4>
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label class="form-label">Application Form <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="application_form" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('application_form')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_application_form"></div>
                    <input type="hidden" name="application_form_photo" id="photo_application_form">
                </div>
                <div class="col-md-6">
                    <label class="form-label">(1) 1x1 ID Picture <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="id_picture" accept=".jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('id_picture')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_id_picture"></div>
                    <input type="hidden" name="id_picture_photo" id="photo_id_picture">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Barangay Clearance <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="barangay_clearance" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('barangay_clearance')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_barangay_clearance"></div>
                    <input type="hidden" name="barangay_clearance_photo" id="photo_barangay_clearance">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Parents ITR / Cert. from BIR / Certificate of Indigency <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="parents_itr" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('parents_itr')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_parents_itr"></div>
                    <input type="hidden" name="parents_itr_photo" id="photo_parents_itr">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Photocopy of Enrolment Form <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="enrolment_form" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('enrolment_form')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_enrolment_form"></div>
                    <input type="hidden" name="enrolment_form_photo" id="photo_enrolment_form">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Schedule of Classes <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="schedule_classes" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('schedule_classes')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_schedule_classes"></div>
                    <input type="hidden" name="schedule_classes_photo" id="photo_schedule_classes">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Proof of Insurance (c/o OSAS) <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="proof_insurance" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('proof_insurance')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_proof_insurance"></div>
                    <input type="hidden" name="proof_insurance_photo" id="photo_proof_insurance">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Grades for the last semester attended <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="grades_last_sem" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('grades_last_sem')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_grades_last_sem"></div>
                    <input type="hidden" name="grades_last_sem_photo" id="photo_grades_last_sem">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Filled Out Official Time <span class="text-danger">*</span></label>
                    <div class="input-with-camera">
                        <div class="custom-file-upload">
                            <input type="file" name="official_time" accept=".pdf,.jpg,.png,.jpeg" required>
                            <span class="custom-file-btn"><i class="fa-solid fa-upload"></i> Choose File</span>
                            <span class="custom-file-text" data-default="No file chosen">No file chosen</span>
                        </div>
                        <button type="button" class="btn-camera-sm" onclick="openCameraModal('official_time')">
                            <i class="fa-solid fa-camera"></i>
                        </button>
                    </div>
                    <div class="file-preview" id="preview_official_time"></div>
                    <input type="hidden" name="official_time_photo" id="photo_official_time">
                </div>
            </div>

            <!-- Submit -->
            <div class="form-actions">
                <a href="{% url 'home:home' %}" class="btn-form btn-form--cancel">
                    <i class="fa-solid fa-arrow-left"></i> Back to Home
                </a>
                <button type="submit" class="btn-form btn-form--submit">
                    <i class="fa-solid fa-paper-plane"></i> Submit Application
                </button>
            </div>
        </form>
    </div>

</main>

<!-- ========== CAMERA MODAL ========== -->
<div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content camera-modal-card">
      <div class="modal-header camera-modal-header">
        <h5 class="modal-title" id="cameraModalLabel">
            <i class="fa-solid fa-camera"></i> Take a Photo
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <!-- Live camera feed -->
        <div class="camera-feed-container">
            <video id="cameraFeed" autoplay playsinline></video>
            <canvas id="cameraCanvas" style="display:none;"></canvas>
        </div>
        <!-- Captured photo preview -->
        <div class="captured-preview-container" id="capturedPreview" style="display:none;">
            <img id="capturedImage" alt="Captured photo">
        </div>
        <p class="camera-status" id="cameraStatus">Starting camera...</p>
      </div>
      <div class="modal-footer camera-modal-footer">
        <button type="button" class="btn-form btn-form--cancel" data-bs-dismiss="modal">
            <i class="fa-solid fa-xmark"></i> Cancel
        </button>
        <button type="button" class="btn-camera-retake" id="btnRetake" style="display:none;" onclick="retakePhoto()">
            <i class="fa-solid fa-arrows-rotate"></i> Retake
        </button>
        <button type="button" class="btn-camera-capture" id="btnCapture" onclick="capturePhoto()">
            <i class="fa-solid fa-camera"></i> Capture
        </button>
        <button type="button" class="btn-form btn-form--submit" id="btnUsePhoto" style="display:none;" onclick="usePhoto()">
            <i class="fa-solid fa-check"></i> Use Photo
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let cameraStream = null;
    let currentField = null;
    const cameraModal = document.getElementById('cameraModal');

    // Open webcam modal for a given field
    function openCameraModal(fieldName) {
        currentField = fieldName;
        const modal = new bootstrap.Modal(cameraModal);
        modal.show();
    }

    // When the modal opens, start the webcam
    cameraModal.addEventListener('shown.bs.modal', function () {
        startCamera();
    });

    // When the modal closes, stop the webcam
    cameraModal.addEventListener('hidden.bs.modal', function () {
        stopCamera();
        resetCameraUI();
    });

    function startCamera() {
        const video = document.getElementById('cameraFeed');
        const status = document.getElementById('cameraStatus');
        status.textContent = 'Starting camera...';

        navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: 'user' } })
            .then(function(stream) {
                cameraStream = stream;
                video.srcObject = stream;
                status.textContent = 'Camera ready — click Capture to take a photo';
            })
            .catch(function(err) {
                status.textContent = 'Could not access camera: ' + err.message;
            });
    }

    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(function(track) { track.stop(); });
            cameraStream = null;
        }
        var video = document.getElementById('cameraFeed');
        video.srcObject = null;
    }

    function capturePhoto() {
        const video = document.getElementById('cameraFeed');
        const canvas = document.getElementById('cameraCanvas');
        const ctx = canvas.getContext('2d');

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        // Show preview
        const dataUrl = canvas.toDataURL('image/png');
        document.getElementById('capturedImage').src = dataUrl;
        document.getElementById('capturedPreview').style.display = 'block';
        video.style.display = 'none';

        // Toggle buttons
        document.getElementById('btnCapture').style.display = 'none';
        document.getElementById('btnRetake').style.display = 'inline-flex';
        document.getElementById('btnUsePhoto').style.display = 'inline-flex';
        document.getElementById('cameraStatus').textContent = 'Photo captured! Use it or retake.';
    }

    function retakePhoto() {
        document.getElementById('capturedPreview').style.display = 'none';
        document.getElementById('cameraFeed').style.display = 'block';
        document.getElementById('btnCapture').style.display = 'inline-flex';
        document.getElementById('btnRetake').style.display = 'none';
        document.getElementById('btnUsePhoto').style.display = 'none';
        document.getElementById('cameraStatus').textContent = 'Camera ready — click Capture to take a photo';
    }

    function usePhoto() {
        const canvas = document.getElementById('cameraCanvas');
        const dataUrl = canvas.toDataURL('image/png');

        // Send captured image to backend for cv2 processing
        fetch("{% url 'home:process_camera_photo' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                image: dataUrl,
                field: currentField
            })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.status === 'ok') {
                // Store the processed image data in the hidden field
                document.getElementById('photo_' + currentField).value = data.filename;

                // Update the file-preview in the form
                var preview = document.getElementById('preview_' + currentField);
                preview.innerHTML = '<i class="fa-solid fa-circle-check" style="color:#22c55e;"></i> <i class="fa-solid fa-camera" style="color:#6b7280;"></i> ' + data.filename;
                preview.style.display = 'block';
            }
        })
        .catch(function(err) {
            alert('Error processing photo: ' + err.message);
        });

        // Close the modal
        bootstrap.Modal.getInstance(cameraModal).hide();
    }

    function resetCameraUI() {
        document.getElementById('capturedPreview').style.display = 'none';
        document.getElementById('cameraFeed').style.display = 'block';
        document.getElementById('btnCapture').style.display = 'inline-flex';
        document.getElementById('btnRetake').style.display = 'none';
        document.getElementById('btnUsePhoto').style.display = 'none';
        document.getElementById('cameraStatus').textContent = '';
    }

    // Show file name on regular file upload
    document.querySelectorAll('input[type="file"]').forEach(function(input) {
        input.addEventListener('change', function() {
            // Update custom file text
            var wrapper = this.closest('.custom-file-upload');
            if (wrapper) {
                var textSpan = wrapper.querySelector('.custom-file-text');
                if (textSpan && this.files.length > 0) {
                    textSpan.textContent = this.files[0].name;
                    textSpan.classList.add('has-file');
                } else if (textSpan) {
                    textSpan.textContent = textSpan.dataset.default;
                    textSpan.classList.remove('has-file');
                }
            }
            var col = this.closest('.col-md-6');
            if (!col) return;
            var preview = col.querySelector('.file-preview');
            if (preview && this.files.length > 0) {
                preview.innerHTML = '<i class="fa-solid fa-circle-check" style="color:#22c55e;"></i> ' + this.files[0].name;
                preview.style.display = 'block';
            }
        });
    });
</script>
</body>
</html>
