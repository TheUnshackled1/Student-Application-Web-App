{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Available Offices - CHMSU Campus Map</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'home/css/style.css' %}?v=5">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
    <!-- Leaflet Marker Cluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
</head>
<body>

<!-- ========== NAVBAR ========== -->
<nav class="navbar">
    <div class="navbar-left d-flex align-items-center gap-2">
        <div class="logo">
            <div class="logo-circle">
                <span class="logo-text">CHMSU</span>
            </div>
        </div>
        <a href="{% url 'home:home' %}" class="btn btn-nav btn-nav--link">
            <i class="fa-solid fa-house"></i>
            <span>HOME</span>
        </a>
        <span class="btn btn-nav btn-nav--active" style="cursor: default;">
            <i class="fa-solid fa-building"></i>
            <span>AVAILABLE OFFICES</span>
        </span>
    </div>
    <div class="navbar-right d-flex align-items-center gap-2">
        <a href="#" class="btn btn-nav btn-nav--apply" data-bs-toggle="modal" data-bs-target="#applyRenewModal">
            <i class="fa-solid fa-paper-plane"></i>
            <span>Apply / Renew as Student Assistant</span>
        </a>
        {% if user.is_authenticated %}
        <form method="post" action="{% url 'logout' %}" style="margin:0;">
            {% csrf_token %}
            <button type="submit" class="btn btn-nav btn-nav--staff" style="border:none; cursor:pointer;">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span>Logout</span>
            </button>
        </form>
        {% else %}
        <a href="{% url 'home:staff_login' %}" class="btn btn-nav btn-nav--staff">
            <i class="fa-solid fa-user-tie"></i>
            <span>Log in as Staff</span>
        </a>
        <a href="{% url 'home:director_login' %}" class="btn btn-nav btn-nav--director">
            <i class="fa-solid fa-user-shield"></i>
            <span>Log in as Student Director</span>
        </a>
        {% endif %}
    </div>
</nav>

<!-- ========== MAIN CONTENT ========== -->
<main class="main-content" style="padding: 20px 24px;">

    <!-- Page Header -->
    <div class="form-page-header">
        <div class="form-icon-circle">
            <i class="fa-solid fa-map-location-dot"></i>
        </div>
        <h2 class="form-page-title">Available Offices &amp; Campus Map</h2>
        <p class="form-page-subtitle">Explore the CHMSU Talisay Campus. Click on a building or office marker to view details and availability for student assistants.</p>
    </div>

    <!-- Office Stats Summary -->
    <div class="staff-stats-row" style="margin-bottom: 16px;">
        <div class="staff-stat-card" style="--stat-gradient: linear-gradient(135deg, #6366f1, #4f46e5);">
            <div class="staff-stat-icon"><i class="fa-solid fa-building"></i></div>
            <div class="staff-stat-info">
                <span class="staff-stat-val">{{ total_offices }}</span>
                <span class="staff-stat-lbl">Total Offices</span>
            </div>
        </div>
        <div class="staff-stat-card" style="--stat-gradient: linear-gradient(135deg, #22c55e, #16a34a);">
            <div class="staff-stat-icon"><i class="fa-solid fa-door-open"></i></div>
            <div class="staff-stat-info">
                <span class="staff-stat-val">{{ total_open }}</span>
                <span class="staff-stat-lbl">Open &mdash; Accepting SA</span>
            </div>
        </div>
        <div class="staff-stat-card" style="--stat-gradient: linear-gradient(135deg, #f59e0b, #d97706);">
            <div class="staff-stat-icon"><i class="fa-solid fa-hourglass-half"></i></div>
            <div class="staff-stat-info">
                <span class="staff-stat-val">{{ total_limited }}</span>
                <span class="staff-stat-lbl">Limited Slots</span>
            </div>
        </div>
        <div class="staff-stat-card" style="--stat-gradient: linear-gradient(135deg, #ef4444, #dc2626);">
            <div class="staff-stat-icon"><i class="fa-solid fa-ban"></i></div>
            <div class="staff-stat-info">
                <span class="staff-stat-val">{{ total_full }}</span>
                <span class="staff-stat-lbl">Full &mdash; No Slots</span>
            </div>
        </div>
    </div>

    <!-- Map & Sidebar Layout -->
    <div class="map-layout">
        <!-- Sidebar: Office List -->
        <div class="map-sidebar">
            <div class="map-sidebar-header">
                <h4><i class="fa-solid fa-list-check"></i> Offices Accepting SA</h4>
                <div class="map-search-box">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="officeSearch" placeholder="Search offices..." autocomplete="off">
                </div>
            </div>
            <div class="office-list" id="officeList">
                <!-- Populated by JS from real data -->
            </div>
            <div class="map-sidebar-footer">
                <div class="map-legend">
                    <h5><i class="fa-solid fa-palette"></i> Legend</h5>
                    <div class="legend-items">
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #22c55e;"></span>
                            <span>Open &mdash; Accepting SA</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #f59e0b;"></span>
                            <span>Limited Slots</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #ef4444;"></span>
                            <span>Full &mdash; No Slots</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #6366f1;"></span>
                            <span>Campus Building</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container-wrapper">
            <div class="map-toolbar">
                <button class="map-tool-btn active" onclick="setMapView('standard')" title="Standard View">
                    <i class="fa-solid fa-map"></i> Standard
                </button>
                <button class="map-tool-btn" onclick="setMapView('satellite')" title="Satellite View">
                    <i class="fa-solid fa-satellite"></i> Satellite
                </button>
                <button class="map-tool-btn" onclick="resetMapView()" title="Reset View">
                    <i class="fa-solid fa-arrows-to-dot"></i> Reset
                </button>
                <button class="map-tool-btn" onclick="toggleFullscreen()" title="Fullscreen">
                    <i class="fa-solid fa-expand"></i> Fullscreen
                </button>
            </div>
            <div id="campusMap"></div>
        </div>
    </div>

    <!-- Office Details Panel (hidden by default) -->
    <div class="office-detail-panel" id="officeDetailPanel" style="display:none;">
        <div class="office-detail-header">
            <h3 id="detailOfficeName"></h3>
            <button class="office-detail-close" onclick="closeDetailPanel()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="office-detail-body">
            <div class="detail-row">
                <i class="fa-solid fa-building"></i>
                <div>
                    <span class="detail-label">Building</span>
                    <span class="detail-value" id="detailBuilding"></span>
                </div>
            </div>
            <div class="detail-row">
                <i class="fa-solid fa-location-dot"></i>
                <div>
                    <span class="detail-label">Floor / Room</span>
                    <span class="detail-value" id="detailRoom"></span>
                </div>
            </div>
            <div class="detail-row">
                <i class="fa-solid fa-clock"></i>
                <div>
                    <span class="detail-label">Office Hours</span>
                    <span class="detail-value" id="detailHours"></span>
                </div>
            </div>
            <div class="detail-row">
                <i class="fa-solid fa-user-tie"></i>
                <div>
                    <span class="detail-label">Head / Supervisor</span>
                    <span class="detail-value" id="detailHead"></span>
                </div>
            </div>
            <div class="detail-row">
                <i class="fa-solid fa-users"></i>
                <div>
                    <span class="detail-label">SA Slots</span>
                    <span class="detail-value" id="detailSlots"></span>
                </div>
            </div>
            <div class="detail-row">
                <i class="fa-solid fa-circle-info"></i>
                <div>
                    <span class="detail-label">Status</span>
                    <span class="detail-value" id="detailStatus"></span>
                </div>
            </div>
            <div class="detail-row">
                <i class="fa-solid fa-align-left"></i>
                <div>
                    <span class="detail-label">Description</span>
                    <span class="detail-value" id="detailDescription"></span>
                </div>
            </div>

            <!-- Assigned Students List -->
            <div class="detail-students-section" id="detailStudentsSection" style="display:none;">
                <h5 style="font-size:13px; font-weight:700; color:#374151; margin:16px 0 10px; padding-top:14px; border-top:1px solid #e5e7eb;">
                    <i class="fa-solid fa-user-graduate" style="color:#1a5632; margin-right:6px;"></i>
                    Assigned Student Assistants
                </h5>
                <div class="detail-student-list" id="detailStudentList"></div>
            </div>
        </div>
        <div class="office-detail-actions">
            <a href="{% url 'home:apply_new' %}" class="btn-form btn-form--submit">
                <i class="fa-solid fa-paper-plane"></i> Apply Here
            </a>
        </div>
    </div>

</main>

<!-- ========== APPLY / RENEW MODAL ========== -->
<div class="modal fade" id="applyRenewModal" tabindex="-1" aria-labelledby="applyRenewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content apply-renew-card">
      <div class="modal-body text-center">
        <div class="modal-icon-circle">
          <i class="fa-solid fa-user-graduate"></i>
        </div>
        <h3 class="modal-heading" id="applyRenewModalLabel">Student Assistant Portal</h3>
        <p class="modal-subtext">What would you like to do?</p>
        <div class="modal-btn-group">
          <a href="{% url 'home:apply_new' %}" class="btn-modal btn-modal--apply">
            <i class="fa-solid fa-file-circle-plus"></i>
            <span>Apply as New Student Assistant</span>
          </a>
          <a href="{% url 'home:apply_renew' %}" class="btn-modal btn-modal--renew">
            <i class="fa-solid fa-arrows-rotate"></i>
            <span>Renew as Student Assistant</span>
          </a>
        </div>
        <button type="button" class="btn-modal-close" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<!-- Leaflet Marker Cluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ========== REAL OFFICE DATA FROM DATABASE ==========
var offices = {{ offices_json|safe }};

var CAMPUS_CENTER = [10.6432, 122.9394];
var CAMPUS_ZOOM = 18;

// Campus buildings (static â€” non-office structures)
var buildings = [
    { name: 'College of Engineering', lat: 10.64270, lng: 122.93880, icon: 'fa-solid fa-gears' },
    { name: 'College of Education', lat: 10.64370, lng: 122.93935, icon: 'fa-solid fa-chalkboard-user' },
    { name: 'Gymnasium / Covered Court', lat: 10.64260, lng: 122.93950, icon: 'fa-solid fa-volleyball' },
    { name: 'Canteen', lat: 10.64280, lng: 122.93860, icon: 'fa-solid fa-utensils' },
    { name: 'Main Gate & Guard House', lat: 10.64380, lng: 122.93945, icon: 'fa-solid fa-dungeon' }
];

// ========== HELPER FUNCTIONS ==========
function createIcon(color, iconClass) {
    return L.divIcon({
        className: 'custom-map-marker',
        html: '<div class="marker-pin" style="background:' + color + ';"><i class="' + iconClass + '" style="color:#fff;font-size:14px;"></i></div>',
        iconSize: [36, 46],
        iconAnchor: [18, 46],
        popupAnchor: [0, -42]
    });
}

function statusColor(status) {
    if (status === 'open') return '#22c55e';
    if (status === 'limited') return '#f59e0b';
    return '#ef4444';
}

function statusLabel(status) {
    if (status === 'open') return 'Open \u2014 Accepting SA';
    if (status === 'limited') return 'Limited Slots';
    return 'Full \u2014 No Slots';
}

// ========== MAP INITIALIZATION ==========
var standardTile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 22,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
});

var satelliteTile = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 22,
    attribution: '&copy; Esri'
});

var satelliteLabels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 22
});

var map = L.map('campusMap', {
    center: CAMPUS_CENTER,
    zoom: CAMPUS_ZOOM,
    layers: [standardTile],
    zoomControl: false
});

L.control.zoom({ position: 'topright' }).addTo(map);
L.control.scale({ position: 'bottomright', imperial: false }).addTo(map);

var currentTileMode = 'standard';

function setMapView(mode) {
    document.querySelectorAll('.map-tool-btn').forEach(function(b){ b.classList.remove('active'); });
    if (mode === 'satellite') {
        map.removeLayer(standardTile);
        map.addLayer(satelliteTile);
        map.addLayer(satelliteLabels);
        document.querySelectorAll('.map-tool-btn')[1].classList.add('active');
    } else {
        map.removeLayer(satelliteTile);
        map.removeLayer(satelliteLabels);
        map.addLayer(standardTile);
        document.querySelectorAll('.map-tool-btn')[0].classList.add('active');
    }
    currentTileMode = mode;
}

function resetMapView() {
    map.setView(CAMPUS_CENTER, CAMPUS_ZOOM);
}

function toggleFullscreen() {
    var wrapper = document.querySelector('.map-container-wrapper');
    wrapper.classList.toggle('map-fullscreen');
    setTimeout(function() { map.invalidateSize(); }, 300);
}

// ========== ADD OFFICE MARKERS (from real DB data) ==========
offices.forEach(function(office) {
    var color = statusColor(office.status);
    var icon = createIcon(color, office.icon);

    // Build student list HTML for popup
    var studentsHtml = '';
    if (office.students && office.students.length > 0) {
        studentsHtml = '<div style="margin-top:8px;border-top:1px solid #e5e7eb;padding-top:8px;">' +
            '<strong style="font-size:11px;color:#374151;">Assigned SAs:</strong>';
        office.students.forEach(function(s) {
            var sColor = s.status_key === 'approved' ? '#16a34a' : '#d97706';
            studentsHtml += '<div style="display:flex;align-items:center;gap:6px;margin-top:4px;font-size:11px;">' +
                '<i class="fa-solid fa-user" style="color:' + sColor + ';font-size:9px;"></i>' +
                '<span>' + s.name + ' (' + s.student_id + ')</span>' +
                '</div>';
        });
        studentsHtml += '</div>';
    }

    var popupHtml =
        '<div class="map-popup">' +
            '<h4>' + office.name + '</h4>' +
            '<p class="popup-building"><i class="fa-solid fa-building"></i> ' + office.building + '</p>' +
            '<p class="popup-room"><i class="fa-solid fa-door-open"></i> ' + office.room + '</p>' +
            '<p class="popup-hours"><i class="fa-solid fa-clock"></i> ' + office.hours + '</p>' +
            '<p class="popup-slots"><i class="fa-solid fa-users"></i> ' + office.available + ' of ' + office.total_slots + ' slots available (' + office.filled + ' filled)</p>' +
            '<span class="popup-status" style="background:' + color + ';">' + statusLabel(office.status) + '</span>' +
            '<p class="popup-desc">' + office.description + '</p>' +
            studentsHtml +
            '<button class="popup-detail-btn" onclick="showOfficeDetail(' + office.id + ')">View Full Details</button>' +
        '</div>';

    var marker = L.marker([office.lat, office.lng], { icon: icon }).addTo(map);
    marker.bindPopup(popupHtml, { maxWidth: 320 });
    office._marker = marker;
});

// ========== ADD BUILDING MARKERS (static) ==========
buildings.forEach(function(bldg) {
    var icon = createIcon('#6366f1', bldg.icon);
    var popupHtml =
        '<div class="map-popup">' +
            '<h4>' + bldg.name + '</h4>' +
            '<span class="popup-status" style="background:#6366f1;">Campus Building</span>' +
        '</div>';
    L.marker([bldg.lat, bldg.lng], { icon: icon }).addTo(map).bindPopup(popupHtml, { maxWidth: 280 });
});

// Campus boundary circle
L.circle(CAMPUS_CENTER, {
    radius: 120,
    color: '#1a5632',
    fillColor: '#1a563220',
    fillOpacity: 0.1,
    weight: 2,
    dashArray: '8,6'
}).addTo(map);

// ========== SIDEBAR OFFICE LIST ==========
function renderOfficeList(filter) {
    var list = document.getElementById('officeList');
    list.innerHTML = '';
    var filtered = offices.filter(function(o) {
        if (!filter) return true;
        return o.name.toLowerCase().indexOf(filter.toLowerCase()) !== -1 ||
               o.building.toLowerCase().indexOf(filter.toLowerCase()) !== -1;
    });

    filtered.forEach(function(office) {
        var color = statusColor(office.status);
        var card = document.createElement('div');
        card.className = 'office-list-card';
        card.setAttribute('data-id', office.id);
        card.innerHTML =
            '<div class="office-list-icon" style="background:' + color + '20; color:' + color + ';">' +
                '<i class="' + office.icon + '"></i>' +
            '</div>' +
            '<div class="office-list-info">' +
                '<h5>' + office.name + '</h5>' +
                '<p><i class="fa-solid fa-building"></i> ' + office.building + '</p>' +
                '<div class="office-list-meta">' +
                    '<span class="office-slots"><i class="fa-solid fa-users"></i> ' + office.available + '/' + office.total_slots + ' slots</span>' +
                    '<span class="office-status-badge" style="background:' + color + ';">' + statusLabel(office.status) + '</span>' +
                '</div>' +
                (office.students.length > 0 ?
                    '<div style="margin-top:6px;font-size:11px;color:#6b7280;">' +
                        '<i class="fa-solid fa-user-graduate" style="margin-right:4px;"></i>' +
                        office.filled + ' student' + (office.filled !== 1 ? 's' : '') + ' assigned' +
                    '</div>' : '') +
            '</div>';
        card.addEventListener('click', function() {
            map.setView([office.lat, office.lng], 20);
            office._marker.openPopup();
            document.querySelectorAll('.office-list-card').forEach(function(c){ c.classList.remove('active'); });
            card.classList.add('active');
        });
        list.appendChild(card);
    });

    if (filtered.length === 0) {
        list.innerHTML = '<div class="office-list-empty"><i class="fa-solid fa-magnifying-glass"></i><p>No offices found</p></div>';
    }
}

renderOfficeList('');

document.getElementById('officeSearch').addEventListener('input', function() {
    renderOfficeList(this.value);
});

// ========== DETAIL PANEL ==========
function showOfficeDetail(officeId) {
    var office = offices.find(function(o){ return o.id === officeId; });
    if (!office) return;

    var color = statusColor(office.status);

    document.getElementById('detailOfficeName').textContent = office.name;
    document.getElementById('detailBuilding').textContent = office.building;
    document.getElementById('detailRoom').textContent = office.room || '\u2014';
    document.getElementById('detailHours').textContent = office.hours;
    document.getElementById('detailHead').textContent = office.head || '\u2014';
    document.getElementById('detailSlots').innerHTML =
        '<strong style="color:' + color + ';">' + office.available + '</strong> of ' +
        office.total_slots + ' available \u2014 ' + office.filled + ' filled';
    document.getElementById('detailStatus').innerHTML =
        '<span class="office-status-badge" style="background:' + color + ';">' + statusLabel(office.status) + '</span>';
    document.getElementById('detailDescription').textContent = office.description || '\u2014';

    // Assigned students
    var studentsSection = document.getElementById('detailStudentsSection');
    var studentList = document.getElementById('detailStudentList');
    if (office.students && office.students.length > 0) {
        studentsSection.style.display = 'block';
        studentList.innerHTML = '';
        office.students.forEach(function(s) {
            var sColor = s.status_key === 'approved' ? '#16a34a' : '#d97706';
            var sBg = s.status_key === 'approved' ? '#dcfce7' : '#fef3c7';
            studentList.innerHTML +=
                '<div style="display:flex; align-items:center; gap:10px; padding:8px 12px; background:#f9fafb; border-radius:10px; margin-bottom:6px;">' +
                    '<div style="width:32px;height:32px;border-radius:50%;background:' + sBg + ';display:flex;align-items:center;justify-content:center;">' +
                        '<i class="fa-solid fa-user" style="color:' + sColor + ';font-size:12px;"></i>' +
                    '</div>' +
                    '<div style="flex:1;">' +
                        '<div style="font-size:13px;font-weight:600;color:#1f2937;">' + s.name + '</div>' +
                        '<div style="font-size:11px;color:#6b7280;">ID: ' + s.student_id + '</div>' +
                    '</div>' +
                    '<span style="font-size:10px;font-weight:700;padding:3px 10px;border-radius:20px;background:' + sBg + ';color:' + sColor + ';">' + s.status + '</span>' +
                '</div>';
        });
    } else {
        studentsSection.style.display = 'block';
        studentList.innerHTML =
            '<div style="text-align:center;padding:12px;color:#9ca3af;font-size:12px;">' +
                '<i class="fa-regular fa-user" style="font-size:18px;margin-bottom:4px;display:block;"></i>' +
                'No student assistants assigned yet' +
            '</div>';
    }

    document.getElementById('officeDetailPanel').style.display = 'block';
    document.getElementById('officeDetailPanel').scrollIntoView({ behavior: 'smooth' });
}

function closeDetailPanel() {
    document.getElementById('officeDetailPanel').style.display = 'none';
}
</script>
</body>
</html>
