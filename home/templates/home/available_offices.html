{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Available Offices - CHMSU Campus Map</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'home/css/style.css' %}?v=4">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
    <!-- Leaflet Marker Cluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
</head>
<body>

<!-- ========== NAVBAR ========== -->
<nav class="navbar">
    <div class="navbar-left d-flex align-items-center gap-2">
        <div class="logo">
            <div class="logo-circle">
                <span class="logo-text">CHMSU</span>
            </div>
        </div>
        <a href="{% url 'home:home' %}" class="btn btn-nav btn-nav--link">
            <i class="fa-solid fa-house"></i>
            <span>HOME</span>
        </a>
        <span class="btn btn-nav btn-nav--active" style="cursor: default;">
            <i class="fa-solid fa-building"></i>
            <span>AVAILABLE OFFICES</span>
        </span>
    </div>
    <div class="navbar-right d-flex align-items-center gap-2">
        <a href="#" class="btn btn-nav btn-nav--apply" data-bs-toggle="modal" data-bs-target="#applyRenewModal">
            <i class="fa-solid fa-paper-plane"></i>
            <span>Apply / Renew as Student Assistant</span>
        </a>
    </div>
</nav>

<!-- ========== MAIN CONTENT ========== -->
<main class="main-content" style="padding: 20px 24px;">

    <!-- Page Header -->
    <div class="form-page-header">
        <div class="form-icon-circle">
            <i class="fa-solid fa-map-location-dot"></i>
        </div>
        <h2 class="form-page-title">Available Offices &amp; Campus Map</h2>
        <p class="form-page-subtitle">Explore the CHMSU Talisay Campus. Click on a building or office marker to view details and availability for student assistants.</p>
    </div>

    <!-- Map & Sidebar Layout -->
    <div class="map-layout">
        <!-- Sidebar: Office List -->
        <div class="map-sidebar">
            <div class="map-sidebar-header">
                <h4><i class="fa-solid fa-list-check"></i> Offices Accepting SA</h4>
                <div class="map-search-box">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="officeSearch" placeholder="Search offices..." autocomplete="off">
                </div>
            </div>
            <div class="office-list" id="officeList">
                <!-- Populated by JS -->
            </div>
            <div class="map-sidebar-footer">
                <div class="map-legend">
                    <h5><i class="fa-solid fa-palette"></i> Legend</h5>
                    <div class="legend-items">
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #22c55e;"></span>
                            <span>Open — Accepting SA</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #f59e0b;"></span>
                            <span>Limited Slots</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #ef4444;"></span>
                            <span>Full — No Slots</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot" style="background: #6366f1;"></span>
                            <span>Campus Building</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container-wrapper">
            <div class="map-toolbar">
                <button class="map-tool-btn active" onclick="setMapView('standard')" title="Standard View">
                    <i class="fa-solid fa-map"></i> Standard
                </button>
                <button class="map-tool-btn" onclick="setMapView('satellite')" title="Satellite View">
                    <i class="fa-solid fa-satellite"></i> Satellite
                </button>
                <button class="map-tool-btn" onclick="resetMapView()" title="Reset View">
                    <i class="fa-solid fa-arrows-to-dot"></i> Reset
                </button>
                <button class="map-tool-btn" onclick="toggleFullscreen()" title="Fullscreen">
                    <i class="fa-solid fa-expand"></i> Fullscreen
                </button>
            </div>
            <div id="campusMap"></div>
        </div>
    </div>

    <!-- Office Details Panel (hidden by default) -->
    <div class="office-detail-panel" id="officeDetailPanel" style="display:none;">
        <div class="office-detail-header">
            <h3 id="detailOfficeName"></h3>
            <button class="office-detail-close" onclick="closeDetailPanel()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="office-detail-body">
            <div class="detail-row">
                <i class="fa-solid fa-building"></i>
                <div>
                    <span class="detail-label">Building</span>
                    <span class="detail-value" id="detailBuilding"></span>
                </div>
            </div>
            <div class="detail-row">
                <i class="fa-solid fa-location-dot"></i>
                <div>
                    <span class="detail-label">Floor / Room</span>
                    <span class="detail-value" id="detailRoom"></span>
                </div>
            </div>
            <div class="detail-row">
                <i class="fa-solid fa-clock"></i>
                <div>
                    <span class="detail-label">Office Hours</span>
                    <span class="detail-value" id="detailHours"></span>
                </div>
            </div>
            <div class="detail-row">
                <i class="fa-solid fa-user-tie"></i>
                <div>
                    <span class="detail-label">Head / Supervisor</span>
                    <span class="detail-value" id="detailHead"></span>
                </div>
            </div>
            <div class="detail-row">
                <i class="fa-solid fa-users"></i>
                <div>
                    <span class="detail-label">SA Slots</span>
                    <span class="detail-value" id="detailSlots"></span>
                </div>
            </div>
            <div class="detail-row">
                <i class="fa-solid fa-circle-info"></i>
                <div>
                    <span class="detail-label">Status</span>
                    <span class="detail-value" id="detailStatus"></span>
                </div>
            </div>
        </div>
        <div class="office-detail-actions">
            <a href="{% url 'home:apply_new' %}" class="btn-form btn-form--submit">
                <i class="fa-solid fa-paper-plane"></i> Apply Here
            </a>
        </div>
    </div>

</main>

<!-- ========== APPLY / RENEW MODAL ========== -->
<div class="modal fade" id="applyRenewModal" tabindex="-1" aria-labelledby="applyRenewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content apply-renew-card">
      <div class="modal-body text-center">
        <div class="modal-icon-circle">
          <i class="fa-solid fa-user-graduate"></i>
        </div>
        <h3 class="modal-heading" id="applyRenewModalLabel">Student Assistant Portal</h3>
        <p class="modal-subtext">What would you like to do?</p>
        <div class="modal-btn-group">
          <a href="{% url 'home:apply_new' %}" class="btn-modal btn-modal--apply">
            <i class="fa-solid fa-file-circle-plus"></i>
            <span>Apply as New Student Assistant</span>
          </a>
          <a href="{% url 'home:apply_renew' %}" class="btn-modal btn-modal--renew">
            <i class="fa-solid fa-arrows-rotate"></i>
            <span>Renew as Student Assistant</span>
          </a>
        </div>
        <button type="button" class="btn-modal-close" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
<!-- Leaflet Marker Cluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ========== CAMPUS DATA ==========
const CAMPUS_CENTER = [10.6432, 122.9394];
const CAMPUS_ZOOM = 18;

// Custom icon factory
function createIcon(color, iconClass) {
    return L.divIcon({
        className: 'custom-map-marker',
        html: `<div class="marker-pin" style="background:${color};"><i class="${iconClass}" style="color:#fff;font-size:14px;"></i></div>`,
        iconSize: [36, 46],
        iconAnchor: [18, 46],
        popupAnchor: [0, -42]
    });
}

// Office & Building data
const offices = [
    {
        id: 'registrar',
        name: 'Office of the Registrar',
        building: 'Administration Building',
        room: 'Ground Floor, Room 101',
        hours: 'Mon–Fri, 8:00 AM – 5:00 PM',
        head: 'Dr. Maria Santos',
        slots: { total: 4, filled: 2 },
        status: 'open',
        lat: 10.64345, lng: 122.93960,
        icon: 'fa-solid fa-file-lines',
        description: 'Handles student records, enrollment, and academic document processing.'
    },
    {
        id: 'library',
        name: 'University Library',
        building: 'Library Building',
        room: '1st & 2nd Floor',
        hours: 'Mon–Sat, 7:30 AM – 6:00 PM',
        head: 'Ms. Elena Reyes',
        slots: { total: 6, filled: 4 },
        status: 'limited',
        lat: 10.64355, lng: 122.93900,
        icon: 'fa-solid fa-book-open',
        description: 'University library with digital resources, reading areas, and research support.'
    },
    {
        id: 'guidance',
        name: 'Guidance Office',
        building: 'Student Services Building',
        room: '2nd Floor, Room 205',
        hours: 'Mon–Fri, 8:00 AM – 5:00 PM',
        head: 'Dr. Roberto Cruz',
        slots: { total: 3, filled: 3 },
        status: 'full',
        lat: 10.64310, lng: 122.93980,
        icon: 'fa-solid fa-comments',
        description: 'Counseling, career guidance, and student welfare services.'
    },
    {
        id: 'deans',
        name: "Dean's Office",
        building: 'Academic Building',
        room: '3rd Floor, Room 301',
        hours: 'Mon–Fri, 8:00 AM – 5:00 PM',
        head: 'Dr. Antonio Garcia',
        slots: { total: 2, filled: 1 },
        status: 'open',
        lat: 10.64290, lng: 122.93920,
        icon: 'fa-solid fa-user-graduate',
        description: 'Academic administration, curriculum management, and faculty coordination.'
    },
    {
        id: 'cashier',
        name: 'Cashier / Finance Office',
        building: 'Administration Building',
        room: 'Ground Floor, Room 103',
        hours: 'Mon–Fri, 8:00 AM – 4:00 PM',
        head: 'Ms. Grace Tan',
        slots: { total: 3, filled: 1 },
        status: 'open',
        lat: 10.64340, lng: 122.93990,
        icon: 'fa-solid fa-coins',
        description: 'Tuition payments, financial aid processing, and budget management.'
    },
    {
        id: 'osa',
        name: 'Office of Student Affairs (OSAS)',
        building: 'Student Services Building',
        room: '1st Floor, Room 102',
        hours: 'Mon–Fri, 8:00 AM – 5:00 PM',
        head: 'Dr. Linda Magtanong',
        slots: { total: 5, filled: 2 },
        status: 'open',
        lat: 10.64300, lng: 122.93950,
        icon: 'fa-solid fa-people-group',
        description: 'Student organizations, activities, scholarships, and student assistant program management.'
    }
];

const buildings = [
    { name: 'Administration Building', lat: 10.64348, lng: 122.93975, icon: 'fa-solid fa-landmark' },
    { name: 'Academic Building', lat: 10.64285, lng: 122.93915, icon: 'fa-solid fa-school' },
    { name: 'Student Services Building', lat: 10.64305, lng: 122.93965, icon: 'fa-solid fa-building-user' },
    { name: 'Library Building', lat: 10.64358, lng: 122.93895, icon: 'fa-solid fa-landmark-dome' },
    { name: 'College of Engineering', lat: 10.64270, lng: 122.93880, icon: 'fa-solid fa-gears' },
    { name: 'College of Education', lat: 10.64370, lng: 122.93935, icon: 'fa-solid fa-chalkboard-user' },
    { name: 'College of Computer Studies', lat: 10.64325, lng: 122.93870, icon: 'fa-solid fa-laptop-code' },
    { name: 'Gymnasium / Covered Court', lat: 10.64260, lng: 122.93950, icon: 'fa-solid fa-volleyball' },
    { name: 'Canteen', lat: 10.64280, lng: 122.93860, icon: 'fa-solid fa-utensils' },
    { name: 'Main Gate & Guard House', lat: 10.64380, lng: 122.93945, icon: 'fa-solid fa-dungeon' },
];

// ========== MAP INITIALIZATION ==========
const standardTile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 22,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
});

const satelliteTile = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 22,
    attribution: '&copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics'
});

const satelliteLabels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 22
});

const map = L.map('campusMap', {
    center: CAMPUS_CENTER,
    zoom: CAMPUS_ZOOM,
    layers: [standardTile],
    zoomControl: false
});

// Add zoom control to top-right
L.control.zoom({ position: 'topright' }).addTo(map);

// Scale bar
L.control.scale({ position: 'bottomright', imperial: false }).addTo(map);

let currentTileMode = 'standard';

function setMapView(mode) {
    document.querySelectorAll('.map-tool-btn').forEach(function(b){ b.classList.remove('active'); });
    if (mode === 'satellite') {
        map.removeLayer(standardTile);
        map.addLayer(satelliteTile);
        map.addLayer(satelliteLabels);
        document.querySelectorAll('.map-tool-btn')[1].classList.add('active');
    } else {
        map.removeLayer(satelliteTile);
        map.removeLayer(satelliteLabels);
        map.addLayer(standardTile);
        document.querySelectorAll('.map-tool-btn')[0].classList.add('active');
    }
    currentTileMode = mode;
}

function resetMapView() {
    map.setView(CAMPUS_CENTER, CAMPUS_ZOOM);
}

function toggleFullscreen() {
    var wrapper = document.querySelector('.map-container-wrapper');
    wrapper.classList.toggle('map-fullscreen');
    setTimeout(function() { map.invalidateSize(); }, 300);
}

// ========== ADD MARKERS ==========
// Status color map
function statusColor(status) {
    if (status === 'open') return '#22c55e';
    if (status === 'limited') return '#f59e0b';
    return '#ef4444';
}

function statusLabel(status) {
    if (status === 'open') return 'Open — Accepting SA';
    if (status === 'limited') return 'Limited Slots';
    return 'Full — No Slots';
}

// Add office markers
offices.forEach(function(office) {
    var color = statusColor(office.status);
    var icon = createIcon(color, office.icon);
    var slotsAvail = office.slots.total - office.slots.filled;

    var popupHtml = `
        <div class="map-popup">
            <h4>${office.name}</h4>
            <p class="popup-building"><i class="fa-solid fa-building"></i> ${office.building}</p>
            <p class="popup-room"><i class="fa-solid fa-door-open"></i> ${office.room}</p>
            <p class="popup-hours"><i class="fa-solid fa-clock"></i> ${office.hours}</p>
            <p class="popup-slots"><i class="fa-solid fa-users"></i> ${slotsAvail} of ${office.slots.total} slots available</p>
            <span class="popup-status" style="background:${color};">${statusLabel(office.status)}</span>
            <p class="popup-desc">${office.description}</p>
            <button class="popup-detail-btn" onclick="showOfficeDetail('${office.id}')">View Full Details</button>
        </div>
    `;

    var marker = L.marker([office.lat, office.lng], { icon: icon }).addTo(map);
    marker.bindPopup(popupHtml, { maxWidth: 300 });
    office._marker = marker;
});

// Add building markers
buildings.forEach(function(bldg) {
    var icon = createIcon('#6366f1', bldg.icon);
    var popupHtml = `
        <div class="map-popup">
            <h4>${bldg.name}</h4>
            <span class="popup-status" style="background:#6366f1;">Campus Building</span>
        </div>
    `;
    L.marker([bldg.lat, bldg.lng], { icon: icon }).addTo(map).bindPopup(popupHtml, { maxWidth: 280 });
});

// Campus boundary circle
L.circle(CAMPUS_CENTER, {
    radius: 120,
    color: '#1a5632',
    fillColor: '#1a563220',
    fillOpacity: 0.1,
    weight: 2,
    dashArray: '8,6'
}).addTo(map);

// ========== SIDEBAR OFFICE LIST ==========
function renderOfficeList(filter) {
    var list = document.getElementById('officeList');
    list.innerHTML = '';
    var filtered = offices.filter(function(o) {
        if (!filter) return true;
        return o.name.toLowerCase().includes(filter.toLowerCase()) ||
               o.building.toLowerCase().includes(filter.toLowerCase());
    });

    filtered.forEach(function(office) {
        var slotsAvail = office.slots.total - office.slots.filled;
        var color = statusColor(office.status);
        var card = document.createElement('div');
        card.className = 'office-list-card';
        card.setAttribute('data-id', office.id);
        card.innerHTML = `
            <div class="office-list-icon" style="background:${color}20; color:${color};">
                <i class="${office.icon}"></i>
            </div>
            <div class="office-list-info">
                <h5>${office.name}</h5>
                <p><i class="fa-solid fa-building"></i> ${office.building}</p>
                <div class="office-list-meta">
                    <span class="office-slots"><i class="fa-solid fa-users"></i> ${slotsAvail}/${office.slots.total} slots</span>
                    <span class="office-status-badge" style="background:${color};">${statusLabel(office.status)}</span>
                </div>
            </div>
        `;
        card.addEventListener('click', function() {
            map.setView([office.lat, office.lng], 20);
            office._marker.openPopup();
            // Highlight
            document.querySelectorAll('.office-list-card').forEach(function(c){ c.classList.remove('active'); });
            card.classList.add('active');
        });
        list.appendChild(card);
    });

    if (filtered.length === 0) {
        list.innerHTML = '<div class="office-list-empty"><i class="fa-solid fa-magnifying-glass"></i><p>No offices found</p></div>';
    }
}

renderOfficeList('');

document.getElementById('officeSearch').addEventListener('input', function() {
    renderOfficeList(this.value);
});

// ========== DETAIL PANEL ==========
function showOfficeDetail(officeId) {
    var office = offices.find(function(o){ return o.id === officeId; });
    if (!office) return;

    var slotsAvail = office.slots.total - office.slots.filled;
    var color = statusColor(office.status);

    document.getElementById('detailOfficeName').textContent = office.name;
    document.getElementById('detailBuilding').textContent = office.building;
    document.getElementById('detailRoom').textContent = office.room;
    document.getElementById('detailHours').textContent = office.hours;
    document.getElementById('detailHead').textContent = office.head;
    document.getElementById('detailSlots').textContent = slotsAvail + ' of ' + office.slots.total + ' available';
    document.getElementById('detailStatus').innerHTML = '<span class="office-status-badge" style="background:' + color + ';">' + statusLabel(office.status) + '</span>';

    document.getElementById('officeDetailPanel').style.display = 'block';
    document.getElementById('officeDetailPanel').scrollIntoView({ behavior: 'smooth' });
}

function closeDetailPanel() {
    document.getElementById('officeDetailPanel').style.display = 'none';
}
</script>
</body>
</html>
